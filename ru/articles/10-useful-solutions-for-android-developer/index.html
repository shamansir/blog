


<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />

<meta name="author" content="Ulric Wilfred" />
<meta name="description" content="Блог о программировании и только о нём. Ни слова о луке. Ни одного. Вообще." />
<meta name="generator" content="mynt v0.3.1" />

<link rel="author me ext" href="http://shamansir.github.io" />
<link rel="contents start home" href="/blog/ru/" />
<link rel="index" href="/blog/ru/archives/" />

<link rel="shortcut icon" href="/blog/ru/assets/img/favicon.png" type="image/x-icon" />

<link rel="alternate" href="/blog/ru/feed.xml" type="application/atom+xml" />



<link rel="stylesheet" href="/blog/ru/assets/css/screen.css" media="screen, projection" type="text/css" />
<link rel="stylesheet" href="/blog/ru/assets/css/print.css" media="print" type="text/css" />
  <!--[if IE]>
      <link rel="stylesheet" href="/blog/ru/assets/css/ie.css" media="screen, projection" type="text/css" />
  <![endif]-->
<link rel="stylesheet" href="/blog/ru/assets/css/pygments.trac.css" type="text/css" />


    
        <!-- WebFonts -->
        <link rel="stylesheet" href="//cloud.webtype.com/css/aeaf962b-fb56-4a2d-af48-f7da7a5ede31.css" type="text/css" />
    

    
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-20770637-6', 'auto');
            ga('send', 'pageview');
        </script>
    






    <title>nwao — 10 полезных решений для разработчика под Android &ndash; Ни слова о луке</title>

</head>

<body>

    <header id="nwao-header">
    <nav id="nwao-nav" role="site-navigation"><ul>
        <li><a href="/blog/ru/" rel="contents" title="Blog">Блог</a></li>
        <li><a href="/blog/ru/archives/" rel="index" title="Архив">Архив</a></li>
        <li><a href="/blog/ru/tags/" title="Метки">Метки</a></li>
        <li><a href="http://shamansir.github.com" rel="author" title="Автор">Автор</a></li>
        <li><a href="/blog/ru/feed.xml" title="Лента RSS">RSS</a></li>
    </ul></nav>

    <h1 id="nwao-title"><a href="/blog/ru/" title="Ни слова о луке">Ни слова о луке</a></h1>
    <div id="nwao-subtitle"><span>сэр шаман рассказывает о чём может</span></div>
</header>

    <ul id="nwao-lang-switch">
        <li><a href="/" title="English Version">English Version</a></li>
        <li>Russian Version</li>
    </ul>

    <div id="top"></div>

    
        <nav role="breadcrumbs" id="nwao-breadcrumbs">
            
    <ul>
        
            
            

            <li><a href="/blog/ru/">Блог</a></li>
        
            
            

            <li><a href="/blog/ru/articles">Статьи</a></li>
        
            
            

            <li>10 полезных решений для ...</li>
        
    </ul>

        </nav>
    

    
        <nav role="dive" id="nwao-dive">
            
    <ul>
        
            <li id="nwao-prev">
                <a href="/blog/ru/articles/latex-study-works/"
                   title="Подготовка учебных документов в LaTeX">Предыдущая статья</a>
            </li>
        
        
            <li id="nwao-next">
                <a href="/blog/ru/articles/sametimed-google-wave-client/"
                   title="Клиент для Google Wave в виде Java Web Application">Следующая статья</a>
            </li>
        
    </ul>

        </nav>
    

    
        <nav role="table-of-contents" id="nwao-toc">
            <h3>Содержание:</h3><a href="#top" title="наверх">(наверх)</a>
            
    
        
            
            
                <ul>
                    
                        
    
        
            
            <li>
                <a href="#section" title="Содержание">Содержание</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-2" title="1. Вступление">1. Вступление</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-3" title="2. Списки с подразделами">2. Списки с подразделами</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-4" title="3. Списки с реагирующими элементами">3. Списки с реагирующими элементами</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-5" title="4. Принудительная инвалидация видов в списках">4. Принудительная инвалидация видов в списках</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-6" title="5. Про кэширование изображений для списков">5. Про кэширование изображений для списков</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-7" title="6. Адаптеры, итерирующиеся по курсорам">6. Адаптеры, итерирующиеся по курсорам</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#oauth-android" title="7. Авторизация через OAuth на Android">7. Авторизация через OAuth на Android</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#http" title="8. Медиа-плеер и буфферинг видео по HTTP">8. Медиа-плеер и буфферинг видео по HTTP</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#asynctask" title="9. Очереди из AsyncTask">9. Очереди из AsyncTask</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#listview" title="10. Подсветка выбора в ListView">10. Подсветка выбора в ListView</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#quickactions" title="11. Добавление QuickActions">11. Добавление QuickActions</a>
                
            </li>
        
    

                    
                        
    
        
            
            <li>
                <a href="#section-8" title="12. Ещё три маленьких решения">12. Ещё три маленьких решения</a>
                
                    <ul>
                        
                            
    
        
            
            <li>
                <a href="#section-9" title="12а. Единое место для вызова различных активити">12а. Единое место для вызова различных активити</a>
                
            </li>
        
    

                        
                            
    
        
            
            <li>
                <a href="#section-10" title="12б. Про плэйсхолдеры в локализации">12б. Про плэйсхолдеры в локализации</a>
                
            </li>
        
    

                        
                            
    
        
            
            <li>
                <a href="#section-11" title="12в. Про некорректные лэйауты">12в. Про некорректные лэйауты</a>
                
            </li>
        
    

                        
                    </ul>
                
            </li>
        
    

                    
                <ul>
            
        
    

        </nav>
    

    <section id="nwao-content" class="nwao-post">
        
    <article>
        <header class="nwao-post-header">
    <h2 class="nwao-post-title">
        <a href="/blog/ru/articles/10-useful-solutions-for-android-developer/" title="10 полезных решений для разработчика под Android">10 полезных решений для разработчика под Android</a>
    </h2>
    <dl class="nwao-post-infoline">
    <dt class="nwao-published">Опубликован</dt>
    <dd class="nwao-published">
        <a href="/blog/ru/archives/2010/"
           title="05 января 2010, вторник. 23:01">
           <time datetime="%d-%m-%Y" pubdate>05 янв 2010</time>
        </a>
    </dd>
    
        <dt class="nwao-tags-title">Метки</dt>
        <dd>
            <div class="nwao-tags">
                
                    <a href="/blog/ru/tags/android/" rel="tag"
                       title="Статьи с меткой 'android'">android</a>
                    
                        <span class="tag-count">2</span>
                    
                    
                        <span class="nwao-comma">,</span>
                    
                
                    <a href="/blog/ru/tags/java/" rel="tag"
                       title="Статьи с меткой 'java'">java</a>
                    
                        <span class="tag-count">11</span>
                    
                    
                        <span class="nwao-comma">,</span>
                    
                
                    <a href="/blog/ru/tags/mobile-dev/" rel="tag"
                       title="Статьи с меткой 'mobile-dev'">mobile-dev</a>
                    
                        <span class="tag-count">3</span>
                    
                    
                        <span class="nwao-comma">,</span>
                    
                
                    <a href="/blog/ru/tags/vimeoid/" rel="tag"
                       title="Статьи с меткой 'vimeoid'">vimeoid</a>
                    
                        <span class="tag-count">1</span>
                    
                    
                
            </div>
        </dd>
    
</dl>
</header>

        <div class="nwao-post-content">
            <h3 id="section">Содержание</h3>
<ol>
<li>Вступление</li>
<li>Про адаптеры списков (<code>ListView</code>) с подразделами (для группировки элементов в списках)</li>
<li>Про списки, содержащие какие-либо действия (элементы списка выполняют что-либо сложное или изменяют себя при выборе)</li>
<li>Про принудительную инвалидацию видов в списках</li>
<li>Про кэширование изображений для <code>ListView</code> (для списков с изображениями)</li>
<li>Про адаптеры, итерирующиеся по курсорам (для поддержки постраничного вывода в списках)</li>
<li>Про авторизацию через OAuth на Android</li>
<li>Про использование <code>MediaPlayer</code> и буфферринг видео полученного по HTTP</li>
<li>Про очереди из нескольких <code>AsyncTask</code> (для поочерёдного выполнения фоновых задач)</li>
<li>Про изменение подсветки выбранного элемента в <code>ListView</code></li>
<li>Про добавление <a href="http://www.londatiga.net/it/how-to-create-quickaction-dialog-in-android/">QuickActions</a> в проект</li>
<li>Ещё три маленьких решения</li>
</ol>
<h3 id="section-2">1. Вступление</h3>
<p>Летом прошлого (уже) года я загорелся желанием написать Android-клиент для веб-сервиса <a href="http://vimeo.com">vimeo</a>. Мне нравится этот сервис, и как по мне, было бы удобно следить за обновлениями в подписках на видео с коммуникатора.</p>

<p>Я задумывал <a href="http://code.google.com/p/vimeoid">этот проект</a> для себя как учебный (в смысле, что учусь я), однако в результате получилось сделать вполне ощутимую часть (можно посмотреть <a href="http://code.google.com/p/vimeoid/wiki/Screenshots">скриншоты того, что готово</a>), однако он пока что не закончен. Такой клиент делаю не я один, <a href="http://www.androlib.com/android.application.com-makotosan-vimeodroid-qmBCn.aspx">свою версию</a> практически одновременно (он был первым) со мной начал делать <a href="http://vimeo.com/makotosan">makotosan</a> и его версия пока что, похоже, тоже ещё делается).</p>

<p>В любом случае, в процессе написания проекта я получил некоторую базу знаний, которой и спешу поделиться. Не все темы экслюзивны, но некоторые рассматриваемые тонкости не раскрыты в интернете или закопаны довольно глубоко в его недрах. <em>Я буду дополнительно приводить примеры из искходных кодов vimeoid, это позволит вам подcмотреть как рассматриваемая тема работает в реальном времени</em> (<em>NB</em>: некоторые ссылки ведут на конкретные строки в коде).</p>
<h3 id="section-3">2. Списки с подразделами</h3>
<p>Кроме обычного использования <code>ListView</code>, часто требуется сделать список, в котором элементы сгруппированы по нескольким разделам в таком виде: заголовок раздела, пункт, пункт, пункт, &hellip;, заголовок раздела, пункт, пункт, &hellip;, заголовок раздела, пункт, пункт, &hellip; и т.д. На картинке это разделы &ldquo;Statistics&rdquo; и &ldquo;Information&rdquo;.</p>

<p>(здесь и далее я буду использовать слово <em>пункт</em> как аналог английскому <em>item</em>, чтобы отличать элемент списка, который может быть и заголовком раздела и пунктом, от пункта, обычного элемента, который не может быть заголовком)</p>

<p><img src="/blog/ru/figures/10-useful-solutions-for-android-developer/guest-channel.png" alt="Список с разделами"></p>

<p>Заголовки не должны реагировать на нажатия и выбор и должны иметь собственный вид. Этого можно достичь, переопределив кроме <code>getView</code> методы <code>getItemViewType</code>, <code>getViewTypeCount</code> и <code>isEnabled</code> адаптера этого списка и отнаследовав его, например, от <code>BaseAdapter</code>.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SectionedItemsAdapter</span> <span class="kd">extends</span> <span class="n">BaseAdapter</span> <span class="o">{</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
</pre></div>
</td></tr></table></div></div>
<ul>
<li>Пример из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/adapter/SectionedActionsAdapter.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>SectionedActionsAdapter</code></a></li>
</ul>

<p>Прежде всего заводятся константы, которые однозначно идентифицируют тип элемента, одна для заголовка, вторая для пункта (то есть типов может быть и больше двух, однако в таком случае лучше использовать <code>enum</code> с набором идентификаторов):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ITEM_VIEW_TYPE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="err">\\</span> <span class="err">пункт</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SECTION_VIEW_TYPE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="err">\\</span> <span class="err">раздел</span>
</pre></div>
</td></tr></table></div></div>
<p>Потом константа, содержащая количество типов элементов (в нашем случае - два):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">VIEW_TYPES_COUNT</span> <span class="o">=</span> <span class="n">SECTION_VIEW_TYPE</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</pre></div>
</td></tr></table></div></div>
<p>Адаптер будет содержать в себе информацию обо всех элементах, поэтому реализации <code>getCount</code>, <code>getItem</code> и <code>getItemId</code> зависят от вашей ситуации.</p>

<p>Метод <code>getItemViewType</code> должен возвращать константу соответствующую типу элемента по его позиции. Для неопределённого типа элемента в классе <code>Adapter</code> существует константа <code>IGNORE_ITEM_VIEW_TYPE</code>.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">getItemViewType</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(.</span> <span class="o">.</span> <span class="o">.)</span> <span class="k">return</span> <span class="n">ITEM_VIEW_TYPE</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(.</span> <span class="o">.</span> <span class="o">.)</span> <span class="k">return</span> <span class="n">SECTION_VIEW_TYPE</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">IGNORE_ITEM_VIEW_TYPE</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>В моём случае я храню в адаптере список разделов, в которых содержатся им принадлежащие пункты. Таким образом у каждого раздела можно спросить сколько внутри него пунктов и засчёт этого узнать необходимый тип.</p>

<p>Этот метод теперь можно использовать в переопределении <code>getView</code>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">viewType</span> <span class="o">=</span> <span class="n">getItemViewType</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">viewType</span> <span class="o">==</span> <span class="n">IGNORE_ITEM_VIEW_TYPE</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Failed to get object at position &quot;</span> <span class="o">+</span> <span class="n">position</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">viewType</span> <span class="o">==</span> <span class="n">SECTION_VIEW_TYPE</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">convertView</span> <span class="o">=</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="c1">// здесь можно через LayoutInflater получить Layout для заголовка раздела</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">viewType</span> <span class="o">==</span> <span class="n">ITEM_VIEW_TYPE</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">convertView</span> <span class="o">=</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="c1">// здесь можно через LayoutInflater получить Layout для пункта</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">convertView</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Метод <code>isEnabled</code> должен возвращать <code>false</code> для элементов, на которые нельзя нажимать и на которые нельзя переходить курсором и <code>true</code> для остальных. Здесь снова поможет <code>getItemViewType</code>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getItemViewType</span><span class="o">(</span><span class="n">position</span><span class="o">)</span> <span class="o">!=</span> <span class="n">SECTION_VIEW_TYPE</span> <span class="o">};</span>
</pre></div>
</td></tr></table></div></div>
<p>Метод <code>getViewTypeCount</code> возвращает ту самую константу, количество возможных типов элементов:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">getViewTypeCount</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">VIEW_TYPES_COUNT</span><span class="o">;</span> <span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Кстати, можно хранить ссылку на <code>LayoutInflater</code> в самом адаптере, а получать её от создавшей его активити через конструктор.</p>

<p>Это всё необходимое для реализации списка с разделами, если нужно - поглядывайте в пример, но прежде дам несколько пояснений.</p>

<p>В примере я использую структуры для хранения данных о разделах и пунктах. В структуре раздела хранится идентификатор раздела, его заголовок и структуры пунктов, содержащихся в нём. Структура пункта хранит указатель на родительскую структуру раздела, заголовок пункта, путь к иконке и обработчик нажатия на пункт (о нём в следующей главе). Конструкторы обоих структур доступны только в адаптерах:</p>

<ul>
<li>Пример из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/adapter/LActionItem.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>LActionItem</code></a></li>
</ul>

<p>Таким образом я упростил добавление групп и пунктов в список. Адаптер имеет методы:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addSection</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">);</span>
<span class="kd">public</span> <span class="n">LActionItem</span> <span class="nf">addItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">section</span><span class="o">,</span> <span class="kt">int</span> <span class="n">icon</span><span class="o">,</span> <span class="n">String</span> <span class="n">title</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<p>Метод <code>addSection</code> возвращает идентификатор группы, который затем можно использовать для добавления пунктов в эту группу:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">final</span> <span class="kt">int</span> <span class="n">suitsSection</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="na">addSection</span><span class="o">(</span><span class="s">&quot;Suits&quot;</span><span class="o">);</span>
<span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">suitsSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">heart</span><span class="o">,</span> <span class="s">&quot;Hearts&quot;</span><span class="o">);</span>
<span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">suitsSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">diamond</span><span class="o">,</span> <span class="s">&quot;Diamonds&quot;</span><span class="o">);</span>
<span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">suitsSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">spade</span><span class="o">,</span> <span class="s">&quot;Spades&quot;</span><span class="o">);</span>
<span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">suitsSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">cross</span><span class="o">,</span> <span class="s">&quot;Crosses&quot;</span><span class="o">);</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">figuresSection</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="na">addSection</span><span class="o">(</span><span class="s">&quot;Figures&quot;</span><span class="o">);</span>
<span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">figuresSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">king</span><span class="o">,</span> <span class="s">&quot;King&quot;</span><span class="o">);</span>
<span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">figuresSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">queen</span><span class="o">,</span> <span class="s">&quot;Queen&quot;</span><span class="o">);</span>
<span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
</pre></div>
</td></tr></table></div></div><h3 id="section-4">3. Списки с реагирующими элементами</h3>
<p>Иногда нужно, чтобы при нажатии на элементе списка он изменил своё состояние и/или перешёл на другую активити. Например, элемент &ldquo;зафолловить&rdquo; в списке с действиями над аккаунтом в твиттере может содержать иконку с минусом, если вы ещё не фолловили этого человека и менять иконку на плюс после нажатия и пришедшего подтверждения о фолловинге. Можно обрабатывать выбранный элемент в текущей <code>ListActivity</code> и в зависимости от позиции предпринимать решение, но если список содержится где-то внутри обычной <code>Activity</code>, то возможно легче обрабатывать выбор в адаптере.</p>

<ul>
<li>Пример из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/adapter/SectionedActionsAdapter.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>SectionedActionsAdapter</code></a></li>
<li>Использует: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/adapter/LActionItem.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>LActionItem</code></a></li>
<li>Используется в: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/base/SingleItemActivity_.java?r=85e18485bdda1c526141170f67e65f4e00202f34#49"><code>SingleItemActivity_</code></a></li>
</ul>

<p>Если вы согласны с этим, ваш адаптер может имплементировать интерфейс <code>OnItemClickListener</code>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActionsAdapter</span> <span class="kd">extends</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="kd">implements</span> <span class="n">OnItemClickListener</span>
</pre></div>
</td></tr></table></div></div>
<p>А в использующей его активити можно сделать:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">final</span> <span class="n">ListView</span> <span class="n">actionsList</span> <span class="o">=</span> <span class="o">(</span><span class="n">ListView</span><span class="o">)</span><span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">actionsList</span><span class="o">);</span>
<span class="kd">final</span> <span class="n">SectionedActionsAdapter</span> <span class="n">actionsAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActionsAdapter</span><span class="o">(.</span> <span class="o">.</span> <span class="o">.);</span>
<span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="c1">// заполнить адаптер значениями</span>
<span class="n">actionsList</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">actionsAdapter</span><span class="o">);</span>
<span class="n">actionsList</span><span class="o">.</span><span class="na">setOnItemClickListener</span><span class="o">(</span><span class="n">actionsAdapter</span><span class="o">);</span>
</pre></div>
</td></tr></table></div></div>
<p>В моём случае за пункты в каждом разделе выступают какие-то действия - переходы на активити либо изменения вида пункта после запроса к серверу. Поэтому я предпочёл сделать структуры с публично доступными свойствами для разделов и пунктов, при этом структуры пунктов содержат обработчик <code>OnClick</code> который принимает <code>View</code> на котором произошёл выбор, поэтому можно изменять <code>View</code> прямо из них. Благодаря этому в адаптере можно просто передать действие обработчику:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onItemClick</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">LActionItem</span> <span class="n">item</span> <span class="o">=</span> <span class="o">(</span><span class="n">LActionItem</span><span class="o">)</span> <span class="n">getItem</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">onClick</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">item</span><span class="o">.</span><span class="na">onClick</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Используя описанный выше метод <code>addItem</code> можно устанавливать обработчик:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">final</span> <span class="n">LActionItem</span> <span class="n">heartsItem</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">suitsSection</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">heart</span><span class="o">,</span> <span class="s">&quot;Hearts&quot;</span><span class="o">);</span>
<span class="n">heartsItem</span><span class="o">.</span><span class="na">onClick</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnClickListener</span><span class="o">()</span> <span class="o">{</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="o">}</span> <span class="o">};</span>
</pre></div>
</td></tr></table></div></div><h3 id="section-5">4. Принудительная инвалидация видов в списках</h3>
<p><code>ListView</code> в Android, как известно, устроены с небольшой хитростью, эта хитрость - <a href="http://android.amberfog.com/?p=296"><em>ListView Recycler</em></a>. Приницип <em>Recycler</em>&lsquo;а, если кратко, состоит в том, что если в списке элементов больше, чем вмещается на экран, при прокручивании списка виды новых элементы не создаются, а переиспользуются виды старых - на этом приниципе работают имплементации <code>getView</code> в адаптерах.</p>

<p>Если в какой-то момент требуется обновить (инвалидировать) конкретный известный вид элемента (или даже его дочерний вид) списка в то время, когда он видим на экране, можно вызвать <code>ListView.invalidate()</code> или <code>Adapter.notifyDataSetChanged()</code>, но иногда эти методы нерационально обновляют и соседние виды, а то и вообще все видимые (особенно если layout <a href="http://www.curious-creature.org/2009/02/22/android-layout-tricks-1/">построен неправильно</a>). Есть способ получить текущий вид элемента списка используя метод <code>ListView.getChildAt(position)</code>. Однако <code>position</code> в данном случае это не индекс элемента в списке, как можно было бы ожидать, а индекс относительно видимых на экране видов. Поэтому полезными будут такие методы:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">View</span> <span class="nf">getItemViewIfVisible</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">itemPos</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">firstPosition</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getFirstVisiblePosition</span><span class="o">();</span>
      <span class="kt">int</span> <span class="n">wantedChild</span> <span class="o">=</span> <span class="n">itemPos</span> <span class="o">-</span> <span class="n">firstPosition</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">wantedChild</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">wantedChild</span> <span class="o">&gt;=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getChildCount</span><span class="o">())</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">return</span> <span class="n">holder</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">wantedChild</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invalidateByPos</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">View</span> <span class="n">itemView</span> <span class="o">=</span> <span class="n">getItemViewIfVisible</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">position</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">itemView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">itemView</span><span class="o">.</span><span class="na">invalidate</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p><code>invalidateByPos</code> обновляет вид только если он видим на экране (насильно вызывая <code>getView</code> адаптера), а если элемент не видим - <code>getView</code> адаптера будет вызван автоматически когда этот вид появится в области видимости при прокрутке списка. Чтобы обновить некий дочерний вид элемента, вы можете использовать метод <code>getViewIsVisible</code>, он вернёт вид элемента из которого можно получить доступ к его дочерним видам и <code>null</code>, если вид не видим пользователю и в обновлении нет необходимости.</p>

<ul>
<li>Методы описаны в классе: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/util/Utils.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>Utils</code></a></li>
</ul>
<h3 id="section-6">5. Про кэширование изображений для списков</h3>
<p><img src="/blog/ru/figures/10-useful-solutions-for-android-developer/guest-videos.png" alt="Список с картинками"></p>

<p>Если вы создаёте список <code>ListView</code>, содержащий изображения загружаемые из сети, эта глава для вас. Неразумно бы было при каждом вызове <code>getView</code> в адаптере получать изображения по URL заново - естественно лучше бы было их а) кэшировать б) запрашивать только тогда, когда вид с изображением видим пользователю. На данный момент эта задача так часто вставала перед программистами на Android, что уже существует <a href="http://stackoverflow.com/questions/541966/android-how-do-i-do-a-lazy-load-of-images-in-listview">множество её решений</a>.</p>

<p>Мой вариант оттуда же, это решение <a href="http://stackoverflow.com/questions/541966/android-how-do-i-do-a-lazy-load-of-images-in-listview/3068012#3068012">Фёдора Власова</a>, исправленное под мои нужды. Во-первых, я сделал каталог для хранения кэшированных изображений статическим - то есть он создаётся единожды за время жизни приложения и стабильно очищается при вызове <code>clearCache</code> (этот метод полезно вызывать в <code>onDestroy()</code> у активити, использующей <code>ImageLoader</code> или в <code>finalize()</code> у использующего его адаптера), немного изменил способ создания этого каталога (см. <code>Utils.createCacheDir()</code>). Во-вторых, в конструктор можно передать идентификаторы изображений, которые будут показаны на месте картинки в процессе её загрузки и/или если загрузить её не удалось. В-третьих ещё пара мелких изменений. Вообще, этот класс можно было бы и сделать синглтоном, изменяя настройки перед использованием, но это уже на ваше усмотрение. В моём случае по одному его экземпляру создаётся для каждой запущенной <code>ListActivity</code> и передаётся адаптерам каждого нуждающегося <code>ListView</code> (или создаётся в самих адаптерах, если <code>ListView</code> находится внутри обычной <code>Activity</code>). Основной метод - <code>displayImage(String url, ImageView view)</code>, его определение говорит само за себя.</p>

<ul>
<li>Исходник из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/com/fedorvlasov/lazylist/ImageLoader.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>ImageLoader</code></a></li>
<li>Использует методы из: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/util/Utils.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>Utils</code></a></li>
</ul>
<h3 id="section-7">6. Адаптеры, итерирующиеся по курсорам</h3>
<p>Эта глава касается постраничного вывода в <code>ListView</code>. То есть, пользователь видит первые <code>n</code> элементов, прокручивает список до <code>n</code>-ного элемента и только после этого выполняется запрос на следующие <code>n</code> элементов к базе данных или к серверу. Затем пользователь пролистывает список до элемента <code>2n</code> и мы запрашиваем следующую пачку размером <code>n</code> и т.д. В <em>vimeoid</em> я делаю следующий запрос при клике по <code>footerView</code> с надписью &ldquo;Загрузить ещё&hellip;&rdquo; у списка: не автоматически, но техника примерно та же.</p>

<ul>
<li>Загрузка по клику на <code>footerView</code>: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/base/ItemsListActivity_.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>ItemsListActivity_</code></a></li>
<li>Реализация для гостя: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/guest/ItemsListActivity.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>ItemsListActivity</code></a></li>
<li>Реализация для зарегистрированного пользователя: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/user/ItemsListActivity.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>ItemsListActivity</code></a></li>
</ul>

<p>Здесь более сложная иерархия классов, загрузка каждой страницы осуществляется через специальный <code>AsyncTask</code>, который после фонового вызова Vimeo API сообщает вызвавшему активити, остались ли ещё элементы и не последняя ли это страница, а активити обновляет свои виды в соответствии с этими данными.</p>

<ul>
<li>Адаптер, содержащий набор курсоров: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/adapter/EasyCursorsAdapter.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>EasyCursorsAdapter</code></a></li>
</ul>

<p>Для того, чтобы обеспечить постраничный вывод, можно просто хранить список из контейнеров для страниц (например, курсоров) в адаптере, а в <code>getView()</code>, если запрошен один из последних элементов, запускать запрос на следующую страницу (предпочтительно - <code>AsyncTask</code>), который при получении нового контейнера добавит его в адаптер и адаптер сможет вызвать <code>notifyDataSetChanged()</code>. Примерно так:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="n">Page</span><span class="o">[]</span> <span class="n">pages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Page</span><span class="o">[</span><span class="n">MAX_PAGES_COUNT</span><span class="o">];</span>

<span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">convertView</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">waitingNextPage</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">pages</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">MAX_PAGES_COUNT</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="o">((</span><span class="n">pages</span><span class="o">.</span><span class="na">length</span> <span class="o">*</span> <span class="n">PER_PAGE</span><span class="o">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)))</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.&gt;</span> <span class="n">nextPageTask</span> <span class="o">=</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.;</span>
        <span class="n">nextPageTask</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">pages</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="c1">// nextPageTask вызывает addSource, когда получает новую страницу</span>

        <span class="n">waitingNextPage</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>

<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addSource</span><span class="o">(</span><span class="n">Page</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pages</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="n">MAX_PAGES_COUNT</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
    <span class="n">pages</span><span class="o">[</span><span class="n">pages</span><span class="o">.</span><span class="na">length</span><span class="o">]</span> <span class="o">=</span> <span class="n">page</span><span class="o">;</span>
    <span class="n">waitingNextPage</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">notifyDataSetChanged</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p><code>EasyCursorsAdapter</code> - хороший пример, где в качестве аналога <code>Page</code> выступает <code>Cursor</code>. Наверняка есть и альтернативные решения, буду рад если их упомянут в комментариях.</p>
<h3 id="oauth-android">7. Авторизация через OAuth на Android</h3>
<p>Если вы пишете клиент для какого-либо сложного веб-сервиса - вы сталкиваетесь с проблемой авторизации, в подавляющем количестве веб-сервисов для её реализации ныне используется <a href="http://en.wikipedia.org/wiki/OAuth">OAuth</a> и Vimeo как раз из числа таких.</p>

<p>Не стоит писать реализацию самому, это несколько неблагодарное дело, благо уже есть отличная библиотека <a href="http://code.google.com/p/oauth-signpost/">signpost</a> и лучших альтернатив, насколько я знаю, пока нет.</p>

<ul>
<li>Пример из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/connection/VimeoApi.java?r=85e18485bdda1c526141170f67e65f4e00202f34#101"><code>VimeoApi</code></a></li>
<li>Использует signpost через: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/connection/JsonOverHttp.java?r=85e18485bdda1c526141170f67e65f4e00202f34#164"><code>JsonOverHttp</code></a></li>
<li>Активити, которое получает токен пользователя: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/ReceiveCredentials.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>ReceiveCredentials</code></a></li>
<li>Его описание в манифесте: <a href="http://code.google.com/p/vimeoid/source/browse/apk/AndroidManifest.xml?r=85e18485bdda1c526141170f67e65f4e00202f34#22"><code>AndroidManifest.xml</code></a></li>
</ul>

<p>Для начала нужно получить уникальный ключ для вашего приложения от веб-сервиса и указать веб-сервису URL, на который будет возвращатся пользователя при успешной авторизации (напр., <code>vimeoid://oauth.done</code>) (но в случае Android его передают при запросе к <code>/request_token</code>). Обычно это делается через веб-интерфейс самого сервиса.</p>

<p>Алгоритм первой авторизации на Android следующий:</p>

<ol>
<li>Указать signpost где у сервиса находятся точки входа в OAuth</li>
<li>Запросом к <code>/request_token</code> получить пару токен/секрет приложения для неавторизированных запросов по этому ключу (колбэк-URL <code>vimeoid://oauth.done</code> передают здесь): <code>provider.retrieveRequestToken(Uri callbackUri)</code>. <em>NB:</em> <code>retrieveRequestToken</code> возвращает не токен, а сразу <code>Uri</code>, тот самый <code>authUri</code> по которому надо обратиться в следующем пункте</li>
<li>Запустить активити браузера, обратиться к <code>/authorize</code>, передав токен приложения и, если необходимо, добавив дополнительные параметры о необходимых правах: <code>startActivity(new Intent(Intent.ACTION_VIEW, authUri + ...))</code></li>
<li>Пользователь увидит страницу в стиле &ldquo;Разрешить этому приложению доступ к вашему аккаунту?&rdquo; (если он разлогинен в сервисе, ему предложат залогиниться). Если он разрешает доступ, браузер перенаправляется по адресу колбэка <code>vimeoid://oauth.done?...</code>, но так как в вашем <code>AndroidManifest.xml</code> для перехвата таких URL описано специальное активити, Android возвращает пользователя к вашему приложению, открывая это самое активити - <code>ReceiveCredentials</code></li>
<li>В активити <code>ReceiveCredentials</code> вы получаете токен пользователя в параметрах <code>Uri uri = getIntent().getData()</code>, теперь по этому токену нужно получить секрет через запрос к <code>/access_token</code>: <code>provider.retrieveAccessToken(Uri uri)</code></li>
<li>Теперь можно сохранить токен и секрет пользователя, например, в приватных <code>SharedPreferences</code>: <code>consumer.getToken()</code>, <code>consumer.getTokenSecret()</code></li>
</ol>

<p>После этого вы можете подписывать каждый запрос к API веб-сервиса полученными токенами: <code>consumer.sign(Object request)</code>. Если ваше приложение было перезапущено, перед всеми запросами можно проверить, нет ли токенов в <code>SharedPreferences</code>, если есть - напомнить о них <code>signpost</code>&#39;у: <code>consumer.setTokenWithSecret(String token, String secret)</code>, а если нет - запросить секрет пользователя заново (или обновить токены, если веб-сервис это позволяет).</p>

<p>Важное замечание: на Android signpost работает только с использованием <code>CommonsHttpOAuthConsumer</code>/<code>CommonsHttpOAuthProvider</code>. Классы <code>DefaultOAuth*</code> не работают.</p>
<h3 id="http">8. Медиа-плеер и буфферинг видео по HTTP</h3>
<p><a href="http://developer.android.com/reference/android/media/MediaPlayer.html"><code>MediaPlayer</code></a> как оказалось, очень трудно заставить работать так, как хочется, в случае проигрывания видео. Чтобы получить видео мне нужно было выполнить необычный HTTP-запрос со специальными заголовками, поэтому получение потока и его буфферизирование пришлось писать вручную. Потоковое воспроизведение по аналогу <a href="http://blog.pocketjourney.com/2009/12/27/android-streaming-mediaplayer-tutorial-updated-to-v1-5-cupcake/">примеров для аудио-файлов</a> у меня не вышло, поэтому пока что я просто загружаю видео полностью и начинаю проигрывание, когда оно уже загрузилось (если на карте не хватит места, я предупреждаю пользователя). При закрытии плеера или неудачном проигрывании я очищаю кэш.</p>

<p>Ещё, поведение <code>VideoView</code>/<code>SurfaceView</code> при переключении видов в пределе одного лэйаута тоже работает очень неоднозначно (чёрный экран через раз), поэтому пришлось банально оставлять в лэйауте один-единственный <code>VideoView</code> и показывать <code>ProgressDialog</code> поверх него, пока видео загружается. Опять же, если вы знаете что-то про потоковое воспроизведение видео средствами <code>MediaPlayer</code> (или о получении чанков вручную), пишите в комментариях.</p>

<p>Поэтому, если в вашем случае вам хватит вызова <code>MediaPlayer.setDataSource(Uri uri)</code>, можете пропустить следующий абзац, большего в ней не рассказывается.</p>

<p>Если же вам тоже пришлось получать поток вручную, я обращу ваше внимание на пару моментов, в остальном просто продемонстрирую код, он должен рассказать всё сам:</p>

<ul>
<li>Пример из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/media/VimeoVideoPlayingTask.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>VimeoVideoPlayingTask</code></a></li>
<li>Вызывается из активити: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/Player.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>Player</code></a></li>
<li>Лэйаут: <a href="http://code.google.com/p/vimeoid/source/browse/apk/res/layout/player.xml?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>player.xml</code></a></li>
</ul>

<p>Загружать поток лучше используя <code>AsyncTask</code>. Я просто агрегирую <code>MediaPlayer</code> внутри <code>...PlayingTask</code> для удобства, вы можете выбрать любой другой способ, но получать поток определённо лучше через <code>AsyncTask</code>. При этом, в методе <code>onPreExecute</code> можно подготовить плеер и настроить его, в <code>doInBackground</code> получить поток видео и вернуть этот поток в <code>onPostExecute</code>, в котором и запустить проигрывание. Опять же, удобно показывать процентный прогресс загрузки, потому что в <code>doInBackground</code> известно количество полученных данных.</p>

<p>Если при загрузке потока возникает исключение, сообщение о нём приходится показывать через <code>runOnUiThread</code>, потому что выполнение задачи было прервано.</p>

<p>Выполнение <code>getWindow().setFormat(PixelFormat.TRANSPARENT);</code> предназначено, чтобы отображённые поверх плеера виды не оставались поверх него после скрытия. Хотя если нужно использовать <code>ViewSwitcher</code>, это всё равно не помогает.</p>

<p>Код получения потока по URL примерно таков:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">InputStream</span> <span class="nf">getVideoStream</span><span class="o">(</span><span class="kt">long</span> <span class="n">videoId</span><span class="o">)</span>
       <span class="kd">throws</span> <span class="n">FailedToGetVideoStreamException</span><span class="o">,</span> <span class="n">VideoLinkRequestException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultHttpClient</span><span class="o">();</span>
        <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
        <span class="kd">final</span> <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">FailedToGetVideoStreamException</span><span class="o">(</span><span class="s">&quot;Failed to get video stream&quot;</span><span class="o">);</span>
        <span class="n">lastContentLength</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">().</span><span class="na">getContentLength</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">().</span><span class="na">getContent</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">URISyntaxException</span> <span class="n">use</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">VideoLinkRequestException</span><span class="o">(</span><span class="s">&quot;URI creation failed : &quot;</span> <span class="o">+</span> <span class="n">use</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClientProtocolException</span> <span class="n">cpe</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">VideoLinkRequestException</span><span class="o">(</span><span class="s">&quot;Client call failed : &quot;</span> <span class="o">+</span> <span class="n">cpe</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">VideoLinkRequestException</span><span class="o">(</span><span class="s">&quot;Connection failed : &quot;</span> <span class="o">+</span> <span class="n">ioe</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div><h3 id="asynctask">9. Очереди из AsyncTask</h3>
<p>Если вам часто приходится выполнять по нескольку фоновых задач поочерёдно (когда завершилось одно - запускать следующее), этот вольный паттерн, скрывающий в себе переходы по связанному списку, вам подойдёт. Например, вам может понадобиться выполнить при загрузке Activity сразу несколько поочерёдных запросов к API некоего веб-сервиса или к базе данных. Главное, чтобы типы параметров и результата у всех этих задач всегда были одинаковыми.</p>

<p>Вот интерфейс задачи, которая знает что у неё есть следующая задача:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">();</span>
    <span class="kt">void</span> <span class="nf">setNextTask</span><span class="o">(</span><span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">);</span>
    <span class="kd">public</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Parames</span><span class="o">&gt;</span> <span class="nf">getNextTask</span><span class="o">();</span>
    <span class="kd">public</span> <span class="n">AsyncTask</span><span class="o">&lt;?,</span> <span class="o">?,</span> <span class="o">?&gt;</span> <span class="n">execute</span><span class="o">(</span><span class="n">Params</span><span class="o">...</span> <span class="n">params</span><span class="o">);</span>
                         <span class="c1">// совпадение с AsyncTask&lt;Params, ...&gt;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Интерфейс, который следит за всеми моментами, когда задачи удачно или неудачно выполняются:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PerformHandler</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPerfomed</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">,</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">nextTask</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">,</span> <span class="n">String</span> <span class="n">description</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Реализация интерфейса <code>HasNextTask</code>. То что представлено многоточиями, можно вынести в дочерний класс или сделать сам класс абстрактным, чтобы методы <code>doInBackground</code>/<code>onPostExecute</code> реализовывались прямо в <code>createTask</code> очереди:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskInQueue</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span>
                                         <span class="kd">implements</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">taskId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">nextTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">PerformHandler</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span> <span class="n">listener</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TaskInQueue</span><span class="o">(</span><span class="n">PerformHandler</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span> <span class="n">listener</span><span class="o">,</span> <span class="kt">int</span> <span class="n">taskId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskId</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">listener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Params</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="cm">/* выполнение задачи */</span> <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">.</span> <span class="o">.</span> <span class="o">.</span> <span class="c1">// обработка результата, если нужно</span>
        <span class="n">listener</span><span class="o">.</span><span class="na">onPerformed</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">nextTask</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="n">getId</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">taskId</span><span class="o">;</span> <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNextTask</span><span class="o">(</span><span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">nextTask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">nextTask</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Next task is already set&quot;</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nextTask</span> <span class="o">=</span> <span class="n">nextTask</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="nf">getNextTask</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextTask</span><span class="o">;</span> <span class="o">};</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Ну и самое главное, реализация очереди:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TasksQueue</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span>
                <span class="kd">implements</span> <span class="n">PerformHandler</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;,</span> <span class="n">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&quot;TasksQueue&quot;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">firstTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">lastTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Params</span><span class="o">&gt;</span> <span class="n">tasksParams</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">currentTask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// сейчас выполняется одна из задач</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">started</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// очередь запущена</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="nf">createTask</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// можно переопределить</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">TaskInQueue</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">taskId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">Params</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Adding task &quot;</span> <span class="o">+</span> <span class="n">taskId</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">createTask</span><span class="o">(</span><span class="n">taskId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">firstTask</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
            <span class="n">lastTask</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
            <span class="n">tasksParams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Params</span><span class="o">&gt;();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">lastTask</span><span class="o">.</span><span class="na">setNextTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
            <span class="n">lastTask</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">tasksParams</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">params</span><span class="o">);</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">task</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Running first task&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isEmpty</span><span class="o">())</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">started</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">execute</span><span class="o">(</span><span class="n">firstTask</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">onError</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">());</span>
                <span class="n">finish</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Queue is empty&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPerfomed</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">,</span> <span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">&gt;</span> <span class="n">nextTask</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Task &quot;</span> <span class="o">+</span> <span class="n">taskId</span> <span class="o">+</span> <span class="s">&quot; performed&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">taskId</span> <span class="o">!=</span> <span class="n">currentTask</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Tasks queue desynchronized&quot;</span><span class="o">);</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nextTask</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">execute</span><span class="o">(</span><span class="n">nextTask</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">onError</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="s">&quot;Error while executing task &quot;</span> <span class="o">+</span>
                       <span class="o">((</span><span class="n">nextTask</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">nextTask</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">:</span> <span class="n">taskId</span><span class="o">));</span>
            <span class="n">finish</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">HasNextTask</span><span class="o">&lt;</span><span class="n">Result</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Trying to run task &quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Tasks queue desynchronized&quot;</span><span class="o">);</span>
        <span class="n">currentTask</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Running task &quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">task</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">tasksParams</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getId</span><span class="o">())).</span><span class="na">get</span><span class="o">();</span> <span class="c1">// wait for result</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finish</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">firstTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">lastTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tasksParams</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">tasksParams</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">tasksParams</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">currentTask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">started</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="o">(</span><span class="n">firstTask</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">started</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">started</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">running</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">running</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span> <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Теперь в ваших активити в любой момент можно с лёгкостью создать очередь фоновых задач:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">protected</span> <span class="kd">final</span> <span class="n">TasksQueue</span> <span class="n">secondaryTasks</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TASK_1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TASK_2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TASK_3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

<span class="kd">public</span> <span class="o">...</span><span class="na">Activity</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// конструктор</span>

    <span class="n">secondaryTasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TasksQueue</span><span class="o">&lt;...,</span> <span class="o">...&gt;()</span> <span class="o">{</span>

        <span class="c1">// здесь можно переопределить createTask</span>

        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">onPerfomed</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="o">...</span> <span class="n">result</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JSONException</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onPerfomed</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
            <span class="n">onSecondaryTaskPerfomed</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">onError</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="n">message</span> <span class="o">+</span> <span class="s">&quot; / &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">());</span>
            <span class="n">Dialogs</span><span class="o">.</span><span class="na">makeExceptionToast</span><span class="o">(</span><span class="n">ItemsListActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">};</span>

    <span class="n">secondaryTasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">TASK_1</span><span class="o">,</span> <span class="o">...);</span>
    <span class="n">secondaryTasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">TASK_2</span><span class="o">,</span> <span class="o">...);</span>
    <span class="n">secondaryTasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">TASK_3</span><span class="o">,</span> <span class="o">...);</span>

<span class="o">}</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">someMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">secondaryTasks</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="n">secondaryTasks</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onSecondaryTaskPerfomed</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">,</span> <span class="o">...</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">taskId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">TASK_1:</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
        <span class="k">case</span> <span class="nl">TASK_2:</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
        <span class="k">case</span> <span class="nl">TASK_3:</span> <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
        <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Кстати, благодаря интерфейсу <code>Runnable</code> такие очереди можно запускать в отдельном потоке:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">secondaryTasks</span><span class="o">,</span> <span class="s">&quot;Tasks Queue&quot;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</pre></div>
</td></tr></table></div></div>
<ul>
<li>Очередь в vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/user/ApiTasksQueue.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>ApiTasksQueue</code></a></li>
<li>Создаётся в: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/user/SingleItemActivity.java?r=85e18485bdda1c526141170f67e65f4e00202f34#49"><code>SingleItemActivity</code></a></li>
<li>Инициализируется задачами в: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/user/item/UserActivity.java?r=85e18485bdda1c526141170f67e65f4e00202f34#122"><code>UserActivity</code></a></li>
<li>Обработка выполненных задач в: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/user/item/UserActivity.java?r=85e18485bdda1c526141170f67e65f4e00202f34#301"><code>UserActivity</code></a></li>
</ul>
<h3 id="listview">10. Подсветка выбора в ListView</h3>
<p><img src="/blog/ru/figures/10-useful-solutions-for-android-developer/user-video.png" alt="Выбранная строка в списке"></p>

<p>На картинке видно синюю полосу, это кастомная подсветка выбранного элемента, она имеет четыре состояния - нажатая, имеющая фокус, запрещённая и анимация перехода от нажатой в зажатую для долгого тапа. Первые три и зажатое состояние - это так называемые <code>9-patch</code>, вы наверняка <a href="http://developer.android.com/guide/developing/tools/draw9patch.html">о них слышали</a>, анимация - <code>xml</code>-файл анимации.</p>

<p>Для того чтобы описать состояния для подсветки выбора, укажите в лэйауте <code>android:listSelector=&quot;@drawable/selector_bg&quot;</code> для вашего <code>ListView</code>.</p>

<p><code>selector_bg.xml</code> - это ещё один <code>xml</code>-файл, набор правил о том как изменяется подстветка в зависимости от состояний. Система проходит по каждому правилу и как только первое правило совпало, оно выполняется, а следующие игнорируются. Алгоритм прост, но выстроить правила в верном порядке не всегда выходит сразу. Смотрите примеры:</p>

<ul>
<li>Описание: <a href="http://code.google.com/p/vimeoid/source/browse/apk/res/drawable/selector_bg.xml?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>selector_bg.xml</code></a></li>
<li>Анимация: <a href="http://code.google.com/p/vimeoid/source/browse/apk/res/drawable/selector_bg_transition.xml?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>selector_bg_transition.xml</code></a></li>
<li>Объявлен в: <a href="http://code.google.com/p/vimeoid/source/browse/apk/res/layout/generic_list.xml?r=85e18485bdda1c526141170f67e65f4e00202f34#16"><code>generic_list.xml</code></a></li>
</ul>

<p><img src="/blog/ru/figures/10-useful-solutions-for-android-developer/draw9patch-norm.png" alt="редактор 9-patch"></p>

<p>С 9-patch тоже есть хитрости, чуть что не так в лэйауте - и они разъезжаются и весь список разъезжается тоже. Главное правило - проверить прежде описание <code>ListView</code>, убедитесь что <code>layout_width</code> и <code>layout_height</code> установлены в <code>fill_parent</code> и кроме того перепроверьте элементы выше по иерархии. Затем, если не помогло, можно исправлять 9-patch. Тонкие чёрные линии сверху и слева обозначают области картинки, которые будут растянуты если контент не влез в картинку. Тонкие чёрные линии (необязательные) справа и снизу обозначают области в которые сам контент будет вписан. Подобрать нужные позиции тоже получается не сразу, приходится экспериментировать. Даже не думайте создавать 9-patch без редактора из коробки, это лишний вынос мозга - в редакторе подсвечиваются области для контента и ошибки, и даже когда всё вроде верно, не всегда раскладка воспринимается инфлейтером как ожидалось.</p>

<p><img src="/blog/ru/figures/10-useful-solutions-for-android-developer/selector_bg_disabled.9.png" alt="Запрещённое состояние"> <img src="/blog/ru/figures/10-useful-solutions-for-android-developer/selector_bg_focus.9.png" alt="Cостояние фокуса"> <img src="/blog/ru/figures/10-useful-solutions-for-android-developer/selector_bg_pressed.9.png" alt="Нажатое состояние"> <img src="/blog/ru/figures/10-useful-solutions-for-android-developer/selector_bg_longpress.9.png" alt="Зажатое состояние"></p>
<h3 id="quickactions">11. Добавление QuickActions</h3>
<p><img src="/blog/ru/figures/10-useful-solutions-for-android-developer/user-videos.png" alt="Пример QuickActions"></p>

<p><a href="http://www.londatiga.net/it/how-to-create-quickaction-dialog-in-android/">QuickActions</a> - небольшая библиотека для всплывающих диалогов с действиями, таких как на рисунке (и не только таких, потому что их дизайн можно менять свободно). Они стали новым популярным веянием при появлении официального твиттер-клиента. Должны быть и другие имплементации, в <em>vimeoid</em> я использую эту, и её тоже немного подправил для своих нужд.</p>

<p>Для того, чтобы отобразить такой диалог вместо контекстного меню при долгом тапе на элементе в списке, достаточно переопределить метод <code>onCreateContextMenu</code> в <code>ListActivity</code> таким образом:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreateContextMenu</span><span class="o">(</span><span class="n">ContextMenu</span> <span class="n">menu</span><span class="o">,</span> <span class="n">View</span> <span class="n">v</span><span class="o">,</span> <span class="n">ContextMenuInfo</span> <span class="n">menuInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="kd">final</span> <span class="n">AdapterView</span><span class="o">.</span><span class="na">AdapterContextMenuInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">extractMenuInfo</span><span class="o">(</span><span class="n">menuInfo</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">QuickAction</span> <span class="n">quickAction</span> <span class="o">=</span>
          <span class="n">createQuickActions</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">position</span><span class="o">,</span> <span class="n">getItem</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">position</span><span class="o">),</span> <span class="n">info</span><span class="o">.</span><span class="na">targetView</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">quickAction</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">quickAction</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="n">QuickAction</span> <span class="nf">createQuickActions</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kd">final</span> <span class="o">...</span> <span class="n">item</span><span class="o">,</span> <span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QuickAction</span> <span class="n">qa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QuickAction</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
    <span class="n">qa</span><span class="o">.</span><span class="na">addActionItem</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">...),</span>
                     <span class="n">getResources</span><span class="o">().</span><span class="na">getDrawable</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">...),</span>
            <span class="k">new</span> <span class="nf">QActionClickListener</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">,</span> <span class="n">QActionItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
                <span class="o">}</span>
            <span class="o">});</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="k">return</span> <span class="n">qa</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<ul>
<li>Каталог, содержащий модифицированную библиотеку <a href="http://code.google.com/p/vimeoid/source/browse/lib-qactions?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>lib-qactions</code></a></li>
<li>Используется в: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/activity/user/list/VideosActivity.java?r=85e18485bdda1c526141170f67e65f4e00202f34#113"><code>VideosActivity</code></a></li>
</ul>

<p>О добавлении внешней библиотеки в проект Eclipse рассказано в <a href="http://developer.android.com/guide/developing/eclipse-adt.html#libraryProject">этой статье</a>. Если кратко, достаточно создать для библиотеки отдельный Android-проект с исходниками, установить чекбокс <code>isLibrary</code> в разделе <code>Android</code> в свойствах этого проекта, а в основном проекте добавить проект с библиотекой пунктом <code>Library</code> -&gt; <code>Add</code> из того же раздела. При этом <code>R</code>-файл из проекта с библиотекой будет добавлен в основной проект.</p>
<h3 id="section-8">12. Ещё три маленьких решения</h3><h4 id="section-9">12а. Единое место для вызова различных активити</h4>
<p>Если в вашем приложении много различных активити и они вызываются схожим образом, возможно будет удобно перенести их вызовы включая заполнение <code>Extras</code> в отдельный класс:</p>

<ul>
<li>Пример из vimeoid: <a href="http://code.google.com/p/vimeoid/source/browse/apk/src/org/vimeoid/util/Invoke.java?r=85e18485bdda1c526141170f67e65f4e00202f34"><code>Invoke</code></a></li>
</ul>
<h4 id="section-10">12б. Про плэйсхолдеры в локализации</h4>
<p>Возможно это очевидно, но в строках из <code>strings.xml</code> можно использовать плейсходеры для того, чтобы подставлять какие-то независимые от локали значения внутрь строк, например: <code>&lt;string name=&quot;image_info&quot;&gt;Image size: {width}x{height}&lt;/string&gt;</code>. В этом поможет функция <code>format</code>, которую можно вызвать так: <code>format(getString(R.string.image_info), &quot;width&quot;, String.valueOf(600), &quot;height&quot;, String.valueOf(800))</code>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">format</span><span class="o">(</span><span class="n">String</span> <span class="n">source</span><span class="o">,</span> <span class="n">String</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;\\{&quot;</span> <span class="o">+</span> <span class="n">params</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span> <span class="o">+</span> <span class="s">&quot;\\}&quot;</span><span class="o">,</span> <span class="n">params</span><span class="o">[</span><span class="n">pos</span><span class="o">++]);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>Upd.</strong> Оказалось, как я и думал, это велосипед: Есть стандартная функция <a href="http://developer.android.com/intl/de/reference/android/content/Context.html#getString%28int,%20java.lang.Object...%29"><code>getString(int resId, Object... formatArgs)</code></a>. Спасибо <a href="http://zochek.habrahabr.ru/">zochek</a>.</p>
<h4 id="section-11">12в. Про некорректные лэйауты</h4>
<p>Обязательно прочитайте эти статьи, инфлэйтер в андроиде действительно очень чувствителен к сложным структурам и если вы пишете сложное приложение, лэйауты рано или поздно придётся оптимизировать:</p>

<ul>
<li><a href="http://www.curious-creature.org/2009/02/22/android-layout-tricks-1/">Layout Tricks #1</a></li>
<li><a href="http://www.curious-creature.org/2009/02/25/android-layout-trick-2-include-to-reuse/">Layout Tricks #2</a></li>
<li><a href="http://www.curious-creature.org/2009/03/01/android-layout-tricks-3-optimize-part-1/">Layout Tricks #3</a></li>
<li><a href="http://www.curious-creature.org/2009/03/16/android-layout-tricks-4-optimize-part-2/">Layout Tricks #4</a></li>
<li><a href="http://www.curious-creature.org/2009/03/04/speed-up-your-android-ui/">Speed up your Android UI</a></li>
</ul>

<p>Мои часто перерендеривающиеся лэйауты в один момент потерпели крах и <code>getView</code> адаптера стал вызываться практически каждую секунду (и до сих пор бывает такое, но уже сильно реже). После замены многих вложенных сложноструктурированных <code>LinearLayout</code>ов на менее вложенные и элегантные <code>RelativeLayout</code>, инфлэйтеру стало явно легче и мне самому тоже, потому что иерархия стала короче и делать мелкие изменения стало проще. Я их ещё не везде успел подменить, но теперь отнощусь к лэйаутам внимательнее. Также следите за тем, чтобы <code>width/height=wrap_content</code> использовался по возможности только для простых элементов, использование <code>wrap_content</code> в качестве параметров ширины/высоты <code>LinearLayout</code> и прочих сложных видов может привести к сложным последствиям. Может и не привести, но кто предупреждён&hellip;</p>

        </div>
    </article>

    </section>

    
        <ul id="nwao-social">
    <li><a href="https://twitter.com/#!/shaman_sir" title="профиль в Twitter"><img src="/blog/ru/assets/img/social/twitter.png" width="16" height="16" alt="профиль в Twitter"></a></li>
    <li><a href="https://github.com/shamansir" title="профиль в Github"><img src="/blog/ru/assets/img/social/github.png" width="16" height="16" alt="профиль в GitHub"></a></li>
    
    <li><a href="https://www.facebook.com/shaman.sir" title="профиль в Facebook"><img src="/blog/ru/assets/img/social/facebook.png" width="16" height="16" alt="профиль в Facebook"></a></li>
    
    
    <li><a href="http://stackoverflow.com/users/167262" title="профиль в Stackoverflow"><img src="/blog/ru/assets/img/social/stack-overflow.png" width="16" height="16" alt="профиль на Stack Overflow"></a></li>
    
</ul>
    

    <div id="nwao-jump-to-top"><a href="#top" title="Наверх">Наверх</a></div>

    <footer id="nwao-footer">
        <p>Copyright &copy; 2014 Ulric Wilfred; запитано <a href="http://mynt.mirroredwhite.com/" title="mynt">mynt</a> и <a href="http://input.fontbureau.com/" title="шрифты Input">шрифтами Input</a></p>
    </footer>

    <!--
    <script type="text/javascript" src="/blog/ru/assets/js/scrolls.js"></script>
    <script type="text/javascript" src="/blog/ru/assets/js/page.scrolls.js"></script> -->

</body>
</html>