<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta charset="utf-8" />

<meta name="author" content="Ulric Wilfred" />
<meta name="description" content="Блог о программировании и только о нём. Ни слова о луке. Ни одного. Вообще." />
<meta name="generator" content="mynt v0.2.3-dev" />

<link rel="author me ext" href="http://shamansir.github.com" />
<link rel="contents start home" href="/blog/ru/" />
<link rel="index" href="/blog/ru/archives/" />

<link rel="shortcut icon" href="/blog/ru/assets/img/favicon.png" type="image/x-icon" />

<link rel="alternate" href="/blog/ru/feed.xml" type="application/atom+xml" />

<link rel="stylesheet" href="/blog/ru/assets/css/screen.css" media="screen, projection" type="text/css" />
<link rel="stylesheet" href="/blog/ru/assets/css/print.css" media="print" type="text/css" />
  <!--[if IE]>
      <link rel="stylesheet" href="/blog/ru/assets/css/ie.css" media="screen, projection" type="text/css" />
  <![endif]-->
<link rel="stylesheet" href="/blog/ru/assets/css/pygments.trac.css" type="text/css" />

<!-- Font Awesome - http://fortawesome.github.com/Font-Awesome -->
<link rel="stylesheet" href="/blog/ru/assets/css/font-awesome.css" />


    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-20770637-6']);
        _gaq.push(['_trackPageview']);
        
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
    <title>nwao — 16 полезных решений для Javascript &ndash; Ни слова о луке</title>

</head>

<body>
    <div id="nwao-page">
        <div id="nwao-header">
            <div id="nwao-holder">
                <nav id="nwao-nav"><ul>
                    <li><a href="/blog/ru/" rel="contents" title="Блог"><i class="icon-home"></i>&nbsp;Блог</a></li>
                    <li><a href="/blog/ru/archives/" rel="index" title="Архив"><i class="icon-book"></i>&nbsp;Архив</a></li>
                    <li><a href="http://shamansir.github.com" rel="author" title="Автор"><i class="icon-user"></i>&nbsp;Автор</a></li>
                    <!-- TODO: TAGS PAGE -->
                    <li><a href="/blog/ru/feed.xml" title="Лента"><i class="icon-rss"></i>&nbsp;RSS</a></li>
                </ul></nav>

                <h1 id="nwao-title"><a href="/blog/ru/" title="Ни слова о луке">&raquo;Ни слова о луке&laquo;</a></h1>
            </div>
            <div id="nwao-subtitle"><span>сэр шаман рассказывает о чём может</span></div>
        </div>

        <!--
        <nav>
          <div id="nwao-dive">
            <a href="#" id="nwao-prev">← Предыдущий пост</a><span> | </span>
            <a href="#" id="nwao-next">Следующий пост →</a>
          </div>
        </nav>
        -->
        
        <div id="nwao-content">
            
    <article id="nwao-post">
        <div class="nwao-post-header">
            <h2 class="nwao-post-title" id="top">
                <a href="#top" title="16 полезных решений для Javascript">
                    16 полезных решений для Javascript
                </a>
            </h2>
            <dl>
    <dt class="nwao-hidden">Опубликован</dt>
    <dd class="nwao-published"><i class="icon-time"></i>&nbsp;12 августа 2007, воскресенье</dd>
    
    <dt class="nwao-hidden">Тэги</dt>
    <dd class="nwao-tags">
    
        <a href="/blog/ru/tags/javascript/" rel="tag" title="Посты с тэгом 'javascript'"><i class="icon-tag"></i>&nbsp;javascript</a><span class="nwao-hidden">,</span> 
    
        <a href="/blog/ru/tags/web-dev/" rel="tag" title="Посты с тэгом 'web-dev'"><i class="icon-tag"></i>&nbsp;web-dev</a>
    
    </dd>
    
</dl>
        </div>
        
        <div class="nwao-post-content">
            <p>Представляю вам набор функций, которые у меня лежат в отдельном файле <code>utils.js</code> - это функции, которые я использую чаще всего. Они стараются быть кроссбраузерными и проверены на IE6/7, FF2 и Safari 2 и на боевой, сложной системе, в XHTML документах. Должны, по идее, работать, и на других, но не очень старых версиях браузеров - проверку браузера я использовал только в исключительных случаях. Некоторая часть из них, конечно же, просто нарыта на просторах интернета (где - обычно указано) и заимствована ввиду открытости, а большая часть - сконструирована из многих ресурсов и своих идей (и советов коллег), дабы работать на ура - поскольку часто в разных скриптах не учитываются разные тонкости, которые, тем не менее - при ближайшем рассмотрении - оказываются общностями :), ну и быть довольно читабельными.</p>

<p>Фукнции разделены тематически:</p>

<ul>
<li><strong><a href="#%D0%BE%D0%BE%D0%BF">ООП</a></strong> &ndash; <em>обеспечение (или, вернее сказать - эмуляция) возможности использовать принципы ООП в JavaScript</em></li>
<li><strong><a href="#%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BD%D0%B0%D1%8F-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-js">Объектная модель JS</a></strong> &ndash; <em>использование и расширение встроенных объектов JS</em></li>
<li><strong><a href="#%D0%BE%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B1%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80%D0%B0">Определение браузера</a></strong> &ndash; <em>чтобы использовать в тех редких случаях, когда это все-таки неизбежно необходимо :)</em></li>
<li><strong><a href="#%D0%BA%D0%BE%D0%BE%D1%80%D0%B4%D0%B8%D0%BD%D0%B0%D1%82%D1%8B-%D0%BF%D0%BE%D0%B7%D0%B8%D1%86%D0%B8%D0%BE%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Координаты / Позиционирование</a></strong> &ndash; <em>вычисление координат и позиционирование объектов - ввиду того, что это часто довольно хитрая штука</em></li>
<li><strong><a href="#dom">DOM</a></strong> &ndash; <em>работа с объектной моделью документа</em></li>
<li><strong><a href="#ajax">AJAX</a></strong> &ndash; <em>вспомогательные функции для AJAX &ndash; так как это средство часто применимо :)</em></li>
<li><strong><a href="#%D0%BB%D0%BE%D0%B3%D0%B3%D0%B8%D0%BD%D0%B3">Логгинг</a></strong> &ndash; <em>иногда он нужен чтобы везде :)</em></li>
</ul>

<p><strong>NB!</strong> (советы по оптимизации и исправлениям приветствуются)</p>

<p><strong>NB!</strong> (при написании статьи примеры были взяты из рабочего кода, но в некоторых навскидку изменены названия функций и даже некоторая функциональность. также к коду функций было применено такое форматирование как переносы строк - на данный момент - без проверки последующей работоспособности. как только код будет полностью проверен на работоспособность - этот комментарий будет отсюда удален)</p>
<h3 id="ооп"><a href="#ооп" title="ООП">ООП</a></h3>
<p><a name="sol-1"></a> <em>1.</em> Первый блок &ndash; набор из трех функций (две из которых пустые :) ), позволяющих применять (эмулировать?) все три принципа <strong>ООП</strong> в <strong>JavaScript</strong>. Из нескольких предложенных на <a href="http://www.ajaxpath.com/javascript-inheritance">AJAXPath</a> и на <a href="http://ajaxpatterns.org/Javascript_Inheritance">AJAXPatterns</a> вариантов я выбрал именно этот ввиду его одновременной понятности и быстрой скорости выполнения и немного его видоизменил так? чтобы отдельно объявленные свойства воспринимались как статические константы.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Class</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="nx">Class</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">construct</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">};</span>

<span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">def</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">classDef</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">Class</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">construct</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">proto</span> <span class="o">=</span> <span class="k">new</span> <span class="k">this</span><span class="p">(</span><span class="nx">Class</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">superClass</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">def</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">def</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">item</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="nx">item</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nx">superClass</span><span class="p">;</span> <span class="k">else</span> <span class="nx">classDef</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
        <span class="nx">proto</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">classDef</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">proto</span><span class="p">;</span>

    <span class="nx">classDef</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">classDef</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div></div>
<p>Полные примеры использования относительно велики, поэтому я их вынесу в <a href="../javascript-oop">следующую статью</a> и проследую далее. Пару простых примеров вы можете наблюдать в пунктах <em><a href="#sol-2">2</a></em>, <em><a href="#sol-5">5</a></em> и <em><a href="#sol-15">15</a></em>.</p>

<p><a name="sol-2"></a> <em>2.</em> Следующая функция &ndash; простая, но изящная &ndash; полезна в сочетании с предыдущим набором &ndash; она <strong>создает функцию-ссылку на метод</strong>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">createMethodReference</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">object</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Теперь можно, например, сделать так:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">ScrollingHandler</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

    <span class="nx">construct</span><span class="o">:</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">elementId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_elementId</span> <span class="o">=</span> <span class="nx">elementId</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">assignListener</span><span class="p">();</span>
        <span class="p">},</span>

    <span class="nx">assignListener</span><span class="o">:</span>
        <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">scrollControlElem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_elementId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">scrollControlElem</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">scrollControlElem</span><span class="p">.</span><span class="nx">onscroll</span> <span class="o">=</span> <span class="nx">createMethodReference</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;_onElementScroll&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>

    <span class="nx">_onElementScroll</span><span class="o">:</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ev</span> <span class="o">=</span> <span class="nx">ev</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;please stop scrolling, I&#39;ve already got an event: &quot;</span> <span class="o">+</span> <span class="nx">ev</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">elmScrollHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ScrollHandler</span><span class="p">(</span><span class="s1">&#39;SomeElmId&#39;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<p>Объект этого класса можно будет ассоциировать с событием скроллинга элемента с указанным ID и совершать что-либо по этому случаю.</p>
<h3 id="объектная-модель-js"><a href="#объектная-модель-js" title="Объектная модель JS">Объектная модель JS</a></h3>
<p><a name="sol-3"></a> <em>3.</em> Нижеприведенная функция <strong>клонирует</strong> любой <strong>объект</strong> вместе со всеми его свойствами:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">cloneObj</span><span class="p">(</span><span class="nx">objToClone</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clone</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">objToClone</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clone</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">objToClone</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">clone</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Использование &ndash; простейшее до невозможности:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">clonedObj</span> <span class="o">=</span> <span class="nx">cloneObj</span><span class="p">(</span><span class="nx">objToClone</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<p><a name="sol-4"></a> <em>4.</em> <strong>Конвертер объектов</strong>, следующая функция, позволяет удобно использовать всяческие условные (и претендующие ими быть :) ) конструкции вида <code>if (tablet.toLowerCase() in oc([&#39;cialis&#39;,&#39;mevacor&#39;,&#39;zocor&#39;])) { alert(’I will not!’) };</code>. Код заимствован <a href="http://snook.ca/archives/javascript/testing_for_a_v/">отсюда</a>.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">oc</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">o</span><span class="p">[</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Для примера возьмем ситуацию, когда сначала требуется определить, входит ли объект в какое-либо множество одиночных объектов, а затем - не входит ли он в сочетании с другим объектом в другое множество пар объектов. Допустим, на вечеринку пускают одиночек только с определенными именами, либо пары из списка с позволенными сочетаниями имен:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">isPersonAllowed</span><span class="p">(</span><span class="nx">maleName</span><span class="p">,</span> <span class="nx">femaleName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pairsAllowed</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">([</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="s2">&quot;Yoko&quot;</span> <span class="p">],</span>
            <span class="p">[</span> <span class="s2">&quot;Bill&quot;</span><span class="p">,</span>  <span class="s2">&quot;Monica&quot;</span> <span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;Phil&quot;</span><span class="p">,</span>  <span class="s2">&quot;Sue&quot;</span> <span class="p">],</span>
            <span class="p">[</span> <span class="s2">&quot;Jason&quot;</span><span class="p">,</span>  <span class="s2">&quot;Harrison&quot;</span> <span class="p">],</span> <span class="p">[</span> <span class="s2">&quot;Adam&quot;</span><span class="p">,</span>  <span class="s2">&quot;Eve&quot;</span> <span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">singlesAllowed</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="s2">&quot;Michael&quot;</span><span class="p">,</span> <span class="s2">&quot;Pete&quot;</span><span class="p">,</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Dave&quot;</span><span class="p">,</span> <span class="s2">&quot;Matthew&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">femaleName</span>
            <span class="o">?</span> <span class="p">([</span><span class="nx">maleName</span><span class="p">,</span> <span class="nx">femaleName</span><span class="p">]</span> <span class="k">in</span> <span class="nx">oc</span><span class="p">(</span><span class="nx">pairsAllowed</span><span class="p">))</span>
            <span class="o">:</span> <span class="p">(</span><span class="nx">maleName</span> <span class="k">in</span> <span class="nx">oc</span><span class="p">(</span><span class="nx">singlesAllowed</span><span class="p">)));</span>
<span class="p">}</span>

<span class="nx">alert</span><span class="p">(</span><span class="nx">isPersonAllowed</span><span class="p">(</span><span class="s2">&quot;Jack&quot;</span><span class="p">));</span> <span class="c1">// false</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">isPersonAllowed</span><span class="p">(</span><span class="s2">&quot;Adam&quot;</span><span class="p">));</span> <span class="c1">// false</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">isPersonAllowed</span><span class="p">(</span><span class="s2">&quot;John&quot;</span><span class="p">));</span> <span class="c1">// true</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">isPersonAllowed</span><span class="p">(</span><span class="s2">&quot;Phil&quot;</span><span class="p">,</span><span class="s2">&quot;Marlo&quot;</span><span class="p">));</span> <span class="c1">// false</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">isPersonAllowed</span><span class="p">(</span><span class="s2">&quot;Jason&quot;</span><span class="p">,</span><span class="s2">&quot;Harrison&quot;</span><span class="p">));</span> <span class="c1">// true</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">isPersonAllowed</span><span class="p">(</span><span class="s2">&quot;Martin&quot;</span><span class="p">,</span><span class="s2">&quot;Luther&quot;</span><span class="p">));</span> <span class="c1">// false</span>
</pre></div>
</td></tr></table></div></div>
<p><a name="sol-5"></a> <em>5.</em> Функция, позволяющая создавать <strong>хэш</strong> сначала кажется немного излишней: объекты в JavaScript &ndash; те же хеши, но вот иногда в качестве имени проперти/ключа требуется задать значение переменной и тогда приходит на помощь функия <code>Hash</code>. (да-да, конечно же есть встроенные возможности, но так возможно просто немного очевиднее :) &ndash; можете исключить эту функцию из полезных, если хотите :) )</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Hash</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Доступ к элементам производится засчет свойства <code>items</code> (кстати, следует, может, в более тяжелой версии добавить <code>keys</code> :) ?):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

    <span class="nx">STG_STOP</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">STG_START</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">STG_LOADING</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">STG_MENU</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">STG_PROCESS</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>

    <span class="nx">construct</span><span class="o">:</span>
        <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stage</span> <span class="o">=</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">STG_LOADING</span><span class="p">;</span> <span class="p">},</span>

    <span class="nx">getStage</span><span class="o">:</span>
        <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stage</span><span class="p">;</span> <span class="p">}</span>

<span class="p">});</span>

<span class="kd">var</span> <span class="nx">stateMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hash</span><span class="p">(</span>
            <span class="p">[</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">STG_START</span><span class="p">,</span>   <span class="s2">&quot;start&quot;</span>    <span class="p">],</span>
            <span class="p">[</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">STG_LOADING</span><span class="p">,</span> <span class="s2">&quot;loading&quot;</span>  <span class="p">],</span>
            <span class="p">[</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">STG_MENU</span><span class="p">,</span>    <span class="s2">&quot;menu&quot;</span>     <span class="p">],</span>
            <span class="p">[</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">STG_PROCESS</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span>  <span class="p">],</span>
            <span class="p">[</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">STG_STOP</span><span class="p">,</span>    <span class="s2">&quot;stopping&quot;</span> <span class="p">]);</span>

<span class="kd">var</span> <span class="nx">someGame</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">();</span>
<span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;You are in &quot;</span><span class="o">+</span><span class="nx">stateMap</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">someGame</span><span class="p">.</span><span class="nx">getStage</span><span class="p">()]</span><span class="o">+</span><span class="s2">&quot; stage!&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<p><a name="sol-6"></a> <em>6.</em> Три других функции просто упрощают и/или делают очевиднее некоторые операции: <code>getTime</code> на 11 символов сокращает доступ к получению <strong>текущего времени</strong>, <code>getTimeDelta</code> позволяет найти <strong>промежуток в милисекундах</strong> между отрезками времени (или указанным моментом и текущим временем, в формате с одним параметром), а последняя функция расширяет <strong>свойства</strong> объекта <strong><code>Number</code>** для того чтобы <strong>при</strong> его **значении <code>NaN</code></strong> можно было чуть быстрее <strong>получить 0</strong>.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getTime</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getTimeDelta</span><span class="p">(</span><span class="nx">timeBegin</span><span class="p">,</span> <span class="nx">timeEnd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timeEnd</span> <span class="o">=</span> <span class="nx">timeEnd</span> <span class="o">||</span> <span class="nx">getTime</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">timeEnd</span> <span class="o">-</span> <span class="nx">timeBegin</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">Number</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">NaN0</span><span class="o">=</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">isNaN</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="k">this</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</td></tr></table></div></div><h3 id="определение-браузера"><a href="#определение-браузера" title="Определение браузера">Определение браузера</a></h3>
<p><a name="sol-7"></a> <em>7.</em> Небольшой объект, поименованные по названиям браузеров свойства которого &ndash; суть условия. Этим достигается более читабельное (но не настолько скурпулезное насколько могло бы быть) <strong>определение большинства типов браузеров</strong>. Этот объект был заимствован мной из проекта, в котором я учавствовал &ndash; и как-то прижился, но, думаю, истинные авторы всё-таки где-то в сети, да и код не так уж сложен и громоздок чтобы на него сильно претендовать :). Кроме того, он конечно не идеально надежен (а некоторые говорят что не надежен вообще), но пока на перечисленных браузерах он меня не подвел ни разу :). Если вас не устраивает такое положение дел - вы можете использовать нечто похожее <a href="http://www.howtocreate.co.uk/jslibs/htmlhigh/sniffer.html">с HowToCreate</a>. И повторюсь: данное определение я стараюсь использовать (как и сказано, например, по ссылке) &ldquo;<em>только в случае если известен конкретный баг в конкретном браузере и его нужно обойти</em>&rdquo;. Также &ndash; несложно пересобрать этот объект в одно длинное условие, для меньшей скорости исполнения (см., опять же, <a href="http://www.howtocreate.co.uk/jslibs/htmlhigh/sniffer.html">ссылку</a>)</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">USER_DATA</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">Browser</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">KHTML</span><span class="o">:</span> <span class="sr">/Konqueror|KHTML/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="sr">/Apple/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">),</span>
        <span class="nx">Safari</span><span class="o">:</span> <span class="sr">/KHTML/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="sr">/Apple/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">),</span>
        <span class="nx">Opera</span><span class="o">:</span> <span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">,</span>
        <span class="nx">MSIE</span><span class="o">:</span> <span class="o">!!</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">),</span>
        <span class="nx">Gecko</span><span class="o">:</span> <span class="sr">/Gecko/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="sr">/Konqueror|KHTML/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span>
    <span class="p">},</span>

    <span class="nx">OS</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">Windows</span><span class="o">:</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Win&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">Mac</span><span class="o">:</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Mac&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">Linux</span><span class="o">:</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Linux&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div><h3 id="координаты-позиционирование"><a href="#координаты-позиционирование" title="Координаты / Позиционирование">Координаты / Позиционирование</a></h3>
<p><a name="sol-8"></a> <em>8.</em> Набор функций, позволяющих получить <strong>координаты элемента</strong> на экране пользователя.</p>

<p>Если ваш документ статичен относительно окна и не имеет скроллбаров &ndash; лучше использовать функцию <code>getPosition</code> &ndash; так будет быстрее. В обратном случае используйте <code>getAlignedPosition</code> &ndash; она учитывает положения скроллбаров. Только обратите внимание: значение <code>top</code> или <code>left</code> у элемента может быть орицательным, если элемент частично расположен за пределами окна &ndash; для синхронизации с курсором мыши иногда нужно обнулить в этом случае высоту. Основной скрипт позаимствован из <a href="http://blog.firetree.net/2005/07/04/javascript-find-position/">одного блога</a>, Aligned-версия &ndash; результат поисков по сусекам и совмещения с информацией из <a href="http://xhtml.ru/2007/03/10/advanced-thumbnail-creator/">двух</a> <a href="http://www.habrahabr.ru/blog/webdev/13897.html">статей</a> (при обнаружении <code>DOCTYPE</code> IE входит в свой собственный, несколько непредсказуемый, режим). Также этот метод скомбинирован с получением позиций из <a href="http://www.webreference.com/programming/javascript/mk/column2/Dragging%20and%20Dropping%20in%20JavaScript_files/drag_drop.js">исходников</a> <a href="http://www.webreference.com/programming/javascript/mk/column2/">руководства по Drag’n&#39;Drop</a>. Обратите внимание: здесь используется функция <code>NaN0</code> из пункта <em><a href="#sol-6">6</a></em>, вам нужно будет добавить ее в скрипт чтобы все работало как надо :) (спасибо, <a href="http://invisibleman.ru/">Homer</a>).</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getPosition</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">top</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">left</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderLeftWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">top</span>  <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderTopWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">left</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderLeftWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">top</span>  <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderTopWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span><span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">top</span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">IS_IE</span> <span class="o">=</span> <span class="nx">USER_DATA</span><span class="p">[</span><span class="s1">&#39;Browser&#39;</span><span class="p">].</span><span class="nx">MSIE</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getAlignedPosition</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">top</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">left</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderLeftWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">top</span>  <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderTopWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">e</span>  <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">)</span> <span class="p">{</span><span class="nx">left</span> <span class="o">-=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">)</span>  <span class="p">{</span><span class="nx">top</span>  <span class="o">-=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">docBody</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="nx">left</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span>
                <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderLeftWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span>
                <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="nx">IS_IE</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span>
        <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">clientLeft</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">();</span>
    <span class="nx">top</span>  <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetTop</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span> <span class="o">?</span>
                <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderTopWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span>
                <span class="o">:</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="nx">IS_IE</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span>
        <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">clientTop</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">();</span>

    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">top</span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<blockquote>
<p>Со временем две приведённые функции слились в одну, несколько более упрощённую, универсальную и при этом корректную (однако, если вы определяете позицию элемента внутри другого элемента, имеющего скроллинг &ndash; не забудьте к координатам первого прибавить значение <code>scrollTop</code> или, соответсвенно, <code>scrollLeft</code> последнего: если вы сделаете это в отдельном месте &ndash; ваш код будет работать быстрее и выглядеть логичнее, чем если бы вы использовали Aligned-версию):</p>
</blockquote>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">findPos</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">baseEl</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">curleft</span> <span class="o">=</span> <span class="nx">curtop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nx">curleft</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
            <span class="nx">curtop</span> <span class="o">+=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">docBody</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">docBody</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">curleft</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">baseEl</span><span class="p">.</span><span class="nx">currentStyle</span><span class="o">?</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">baseEl</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderLeftWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                   <span class="p">(</span><span class="nx">IS_IE</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">clientLeft</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">();</span>
        <span class="nx">curtop</span>  <span class="o">+=</span> <span class="p">(</span><span class="nx">baseEl</span><span class="p">.</span><span class="nx">currentStyle</span><span class="o">?</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">baseEl</span><span class="p">.</span><span class="nx">currentStyle</span><span class="p">.</span><span class="nx">borderTopWidth</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span><span class="o">:</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                   <span class="p">(</span><span class="nx">IS_IE</span> <span class="o">?</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">docBody</span><span class="p">.</span><span class="nx">clientTop</span><span class="p">)).</span><span class="nx">NaN0</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">curleft</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">curtop</span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p><a name="sol-9"></a> <em>9.</em> Определить текущие <strong>координаты курсора</strong> мыши и <strong>смещение элемента относительно курсора</strong> легко, если использовать соответствующие функции (собранные на <a href="http://xhtml.ru/2007/03/10/advanced-thumbnail-creator/">основе</a> <a href="http://www.habrahabr.ru/blog/webdev/13897.html">трёх</a> <a href="http://quirksmode.org/js/events_properties.html">источников</a>):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">mouseCoords</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">||</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">pageY</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">ev</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">ev</span><span class="p">.</span><span class="nx">pageY</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">docBody</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">+</span> <span class="nx">docBody</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">-</span> <span class="nx">docBody</span><span class="p">.</span><span class="nx">clientLeft</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">+</span> <span class="nx">docBody</span><span class="p">.</span><span class="nx">scrollTop</span>  <span class="o">-</span> <span class="nx">docBody</span><span class="p">.</span><span class="nx">clientTop</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getMouseOffset</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">aligned</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ev</span> <span class="o">=</span> <span class="nx">ev</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">aligned</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">aligned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">docPos</span>    <span class="o">=</span> <span class="nx">aligned</span>
        <span class="o">?</span> <span class="nx">getAlignedPosition</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">getPosition</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">mousePos</span>  <span class="o">=</span> <span class="nx">mouseCoords</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">docPos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">docPos</span><span class="p">.</span><span class="nx">y</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<blockquote>
<p>Обновлённая версия функии <code>getMouseOffset</code> для варианта с одной функцией нахождения позиции:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getMouseOffset</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ev</span> <span class="o">=</span> <span class="nx">ev</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">docPos</span> <span class="o">=</span> <span class="nx">findPos</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">mousePos</span> <span class="o">=</span> <span class="nx">mouseCoords</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">docPos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">docPos</span><span class="p">.</span><span class="nx">y</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div></blockquote>

<p>Последняя функция также может использоваться в двух режимах засчет атрибута <code>aligned</code> и предназначена для удобного использования в обработчиках событий, например:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">onMouseMove</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mouseOffset</span> <span class="o">=</span> <span class="nx">getMouseOffset</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;x: %d; y: %d&quot;</span><span class="p">,</span> <span class="nx">mouseOffset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">mouseOffset</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div><div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;someId&quot;</span> <span class="na">onmousemove=</span><span class="s">&quot;onMouseMove(this, event);</span>
<span class="s">    return false;&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>NB!</strong> (если данные функции (<em>вдруг</em> :) ) не заработают в каком-либо определенном случае &ndash; прошу сообщать &ndash; хочется добиться максимальной их переносимости)</p>

<p><a name="sol-10"></a> <em>10.</em> Определение <strong>высоты элемента</strong> иногда более нелегкая задача чем определение других его параметров, но эти две функции придут на помощь:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">findOffsetHeight</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getOffsetHeight</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">||</span>
           <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">pixelHeight</span> <span class="o">||</span>
           <span class="nx">findOffsetHeight</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div><h3 id="dom"><a href="#dom" title="DOM">DOM</a></h3>
<p><a name="sol-11"></a> <em>11.</em> Иногда нужно <strong>пройти рекурсивно по дереву DOM</strong>, начиная с некоторого элемента и выполняя некоторую функцию над каждым из потомков, забираясь в самую глубь. В DOM есть объект <code>TreeWalker</code>, но он не работает в IE и не всегда удобен/прост в использовании. Функция <code>walkTree</code> позволяет выполнить некоторую другую функцию над каждым из элементов и позволяет также передать в нее некоторый пакет данных. Функция <code>searchTree</code> отличается от нее тем, что останавливает проход по дереву при первом удачном результате и возвращает результат в точку вызова:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">walkTree</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">mapFunction</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">mapFunction</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">walkTree</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">mapFunction</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">searchTree</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">searchFunction</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">funcResult</span> <span class="o">=</span> <span class="nx">searchFunction</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">funcResult</span><span class="p">)</span> <span class="k">return</span> <span class="nx">funcResult</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">searchResult</span> <span class="o">=</span> <span class="nx">searchTree</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">searchFunction</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">searchResult</span><span class="p">)</span> <span class="k">return</span> <span class="nx">searchResult</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>В примере используются функции <code>setElmAttr</code> и <code>getElmAttr</code>, которые будут рассмотрены позже - в пункте <em><a href="#sol-13">13</a></em>. По сути они делают то же что и <code>getAttribute</code> и <code>setAttribute</code>. Пояснения к используемой функции <code>oc</code> вы можете посмотреть в пукте <em><a href="#sol-4">4</a></em>. В первой части примера корневому элементу атрибут &ldquo;<code>nodeType</code>&rdquo; устанавливается в &ldquo;<code>root</code>&rdquo;, а всем его потомкам - в &ldquo;<code>child</code>&rdquo;. Во второй части демонстрируется также передача пакета данных &ndash; при нахождении первого элемента с атрибутом &ldquo;<code>class</code>&rdquo;, равным одному из перечисленных в пакете имен, атрибут &ldquo;<code>isTarget</code>&rdquo; ему устанавливается в &ldquo;<code>true</code>&rdquo;.</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;rootElm&#39;</span><span class="p">);</span>

<span class="nx">setElmAttr</span><span class="p">(</span><span class="nx">rootElement</span><span class="p">,</span> <span class="s2">&quot;nodeType&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">childNodeFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">&#39;#text&#39;</span><span class="p">)</span>
                      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">&#39;#comment&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">setElmAttr</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s2">&quot;nodeType&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">walkTree</span><span class="p">(</span><span class="nx">rootElement</span><span class="p">,</span> <span class="nx">childNodeFunc</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">findTargetNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">classList</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">&#39;#text&#39;</span><span class="p">)</span>
                       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">!==</span> <span class="s1">&#39;#comment&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
                       <span class="p">(</span><span class="nx">getElmAttr</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="k">in</span> <span class="nx">oc</span><span class="p">(</span><span class="nx">classList</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">targetNode</span> <span class="o">=</span> <span class="nx">searchTree</span><span class="p">(</span><span class="nx">rootElement</span><span class="p">,</span> <span class="nx">findTargetNode</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;headingClass&#39;</span><span class="p">,</span> <span class="s1">&#39;footerClass&#39;</span><span class="p">,</span> <span class="s1">&#39;tableClass&#39;</span><span class="p">]);</span>
<span class="nx">setElmAttr</span><span class="p">(</span><span class="nx">targetNode</span><span class="p">,</span> <span class="s2">&quot;isTarget&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>NB!</strong> (будьте осторожны с использованием этих функций и постарайтесь избежать их чересчур частого вызова (более раза в секунду) даже на средней ветвистости дереве - они могут пожрать немало ресурсов. или, по крайней мере, вызывайте их в фоне через <code>setTimeout</code>)</p>

<p><a name="sol-12"></a> <em>12.</em> <strong>Удаление узлов</strong> - иногда необходимая задача. Иногда нужно удалить сам узел, а иногда &ndash; только его потомков. Функция <code>removeChildrenRecursively</code> рекурсивно удаляет всех потомков указанного узла, не затрагивая, конечно, его самого. Функция <code>removeElementById</code>, как и сказано в названии, удалает узел по его <code>id</code> - при всей простоте задачи способ относительно хитрый:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeChildrenRecursively</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">hasChildNodes</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">removeChildrenRecursively</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeElementById</span><span class="p">(</span><span class="nx">nodeId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">nodeId</span><span class="p">).</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span>
                            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">nodeId</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p><a name="sol-13"></a> <em>13.</em> Казалось бы &ndash; элементарная задача работы с атрибутами элемента &ndash; иногда наталкивает на абсолютно неожиданные проблемы: например, IE бросает исключение при попытке доступа к атрибутам высоты/ширины элемента <code>table</code>, а у Safari отличается способ доступа к атрибутам с пространствами имен. Приведенные ниже функции обходят все встреченные мной проблемы без сильного ущерба к скорости выполнения (конечно же, в стандартных случаях лучше использовать встроенные функции):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">IS_SAFARI</span> <span class="o">=</span> <span class="nx">USER_DATA</span><span class="p">[</span><span class="s1">&#39;Browser&#39;</span><span class="p">].</span><span class="nx">Safari</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getElmAttr</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// IE6 fails getAttribute when used on table element</span>
    <span class="kd">var</span> <span class="nx">elmValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">elmValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">getAttribute</span>
                    <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">((</span><span class="nx">ns</span> <span class="o">?</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">+</span> <span class="nx">NS_SYMB</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="nx">attrName</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elmValue</span> <span class="o">&amp;&amp;</span> <span class="nx">IS_SAFARI</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elmValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">getAttributeNS</span>
                    <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">getAttributeNS</span><span class="p">(</span><span class="nx">ns</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">)</span>
                    <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">elmValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setElmAttr</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">IS_SAFARI</span> <span class="o">||</span> <span class="o">!</span><span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">setAttribute</span>
                    <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">((</span><span class="nx">ns</span> <span class="o">?</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">+</span> <span class="nx">NS_SYMB</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">setAttributeNS</span>
                    <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">setAttributeNS</span><span class="p">(</span><span class="nx">ns</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
                    <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">remElmAttr</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">IS_SAFARI</span> <span class="o">||</span> <span class="o">!</span><span class="nx">ns</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">removeAttribute</span>
                    <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">((</span><span class="nx">ns</span> <span class="o">?</span> <span class="p">(</span><span class="nx">ns</span> <span class="o">+</span> <span class="nx">NS_SYMB</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="nx">attrName</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">removeAttributeNS</span>
                    <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">removeAttributeNS</span><span class="p">(</span><span class="nx">ns</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">)</span>
                    <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Засчет универсальности появляется некоторая неудобочитаемость ввиду того, что необязательный атрибут пространства имен &ndash; последний. Решения приветствуются.</p>
<h3 id="ajax"><a href="#ajax" title="AJAX">AJAX</a></h3>
<p><a name="sol-14"></a> <em>14.</em> Если вам не нужно ничего большего, чем просто <strong>выполнить асинхронный запрос</strong> и на основе полученных данных сделать нечто &ndash; для вас эта функция. Способ получения объекта <code>XMLHttpRequest</code> безусловно может быть заменен. Комментарии намеренно оставлены, дабы показать некоторые идеи по расширению:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* AJAX call */</span>

<span class="cm">/* locationURL - URL to use */</span>
<span class="cm">/* parameters - url parameters, null if not required (format: &quot;parameter1=value1&amp;parameter2=value2[...]&quot;) */</span>
<span class="cm">/* onComplete - listener: function (http_request) or (http_request, package) */</span>
<span class="cm">/* doPost - (optional) specifies if POST (true) or GET (false/null) request required</span>
<span class="cm">/* package - (optional) some variable or array to tranfer to complete listener, may be not specified */</span>

<span class="kd">function</span> <span class="nx">makeRequest</span><span class="p">(</span><span class="nx">locationURL</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">,</span> <span class="nx">onComplete</span><span class="p">,</span> <span class="nx">doPost</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">http_request</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">http_request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Msxml2.XMLHTTP&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">http_request</span><span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Microsoft.XMLHTTP&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">http_request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//if (http_request.overrideMimeType) { // optional</span>
    <span class="c1">//  http_request.overrideMimeType(&#39;text/xml&#39;);</span>
    <span class="c1">//}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">http_request</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot create XMLHTTP instance&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">completeListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">http_request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">http_request</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">onComplete</span><span class="p">(</span><span class="nx">http_request</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="c1">//var salt = hex_md5(new Date().toString());</span>
    <span class="nx">http_request</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">completeListener</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doPost</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">locationURL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">);</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-length&quot;</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">);</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">parameters</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">locationURL</span> <span class="o">+</span> <span class="p">(</span><span class="nx">parameters</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
        <span class="c1">//http_request.open(&#39;GET&#39;, &#39;./proxy.php?&#39; + parameters +</span>
                    <span class="c1">// &quot;&amp;salt=&quot; + salt, true);</span>
        <span class="nx">http_request</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Пример использования &ndash; из одного моего рабочего тестового задания, которое занималось поиском в базе музыки и/или фильмов по введенной в элемент (с <code>id</code> &ldquo;<code>searchStr</code>&rdquo;) строке, используя SQL’ный <code>LIKE</code>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">gotSearchResults</span><span class="p">(</span><span class="nx">http_request</span><span class="p">,</span> <span class="nx">dataPackage</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request_result</span> <span class="o">=</span> <span class="nx">http_request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">divElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">dataPackage</span><span class="p">[</span><span class="s2">&quot;divId&quot;</span><span class="p">]);</span>
    <span class="nx">divElement</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">request_result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">insertMusicSearchResults</span><span class="p">(</span><span class="nx">divId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">searchStrElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;searchStr&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">dataPackage</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="nx">dataPackage</span><span class="p">[</span><span class="s2">&quot;divId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">divId</span><span class="p">;</span>
    <span class="nx">makeRequest</span><span class="p">(</span><span class="s2">&quot;getAlbums.php&quot;</span><span class="p">,</span> <span class="s2">&quot;searchStr=&quot;</span>
            <span class="o">+</span> <span class="nx">searchStrElement</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">gotSearchResults</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">dataPackage</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">insertVideoSearchResults</span><span class="p">(</span><span class="nx">divId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">searchStrElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;searchStr&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">dataPackage</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="nx">dataPackage</span><span class="p">[</span><span class="s2">&quot;divId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">divId</span><span class="p">;</span>
    <span class="nx">makeRequest</span><span class="p">(</span><span class="s2">&quot;getMovies.php&quot;</span><span class="p">,</span> <span class="s2">&quot;searchStr=&quot;</span>
            <span class="o">+</span> <span class="nx">searchStrElement</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">gotSearchResults</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">dataPackage</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div><h3 id="логгинг"><a href="#логгинг" title="Логгинг">Логгинг</a></h3>
<p><a name="sol-15"></a> <em>15.</em> Представленная ниже функция для помощи в <strong>ведении логов</strong> очень проста, добавьте в нужное место в документе элемент <code>&lt;div id=&quot;LOG_DIV&quot;&gt;&lt;/div&gt;</code>, задайте ему необходимую высоту, и в него будет сбрасываться информация + обеспечиваться ее скроллинг:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">LOG</span><span class="p">(</span><span class="nx">informerName</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">logElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;LOG_DIV&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">logElement</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logElement</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span>
                        <span class="nx">informerName</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">));</span>
        <span class="nx">logElement</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">));</span>
        <span class="nx">logElement</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">+=</span> <span class="mi">50</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p><a name="sol-16"></a> <em>16.</em> В замечательном плагине <a href="http://www.getfirebug.com/">Firebug</a> для браузера Firefox есть замечательная <strong>консоль</strong>, в которую с широкими возможностями можно <a href="http://www.getfirebug.com/console.html">производить логгинг</a>. Однако, если вы отлаживаете параллельно код в других браузерах &ndash; обращения к ней могут вызывать ошибки и даже крэши. Для того чтобы не очищать каждый раз код от логов, можно использовать такую заглушку:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Console</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="c1">// the stub class to allow using console when browser have it,</span>
    <span class="c1">// if not - just pass all calls</span>
    <span class="nx">construct</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
    <span class="nx">log</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">},</span>
    <span class="nx">info</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">},</span>
    <span class="nx">warn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">});</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Console</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Сочетание этого и предыдущего пункта + CSS может вдохновить вас на написание собственной консоли с функциональностью консоли Firebug, но для других браузеров ;). Если вы ее напишете - поделитесь, пожалуйста, со мной :).</p>
<h3 id="бонус"><a href="#бонус" title="Бонус">Бонус</a></h3>
<p>В качестве бонуса (чтобы не портить приятно отдающее двоичностью число в заголовке :) ) рассажу о проблеме <strong>двойного клика</strong> &ndash; бился над ней не я, а мои коллеги, решение также сетевое &ndash; но в некоторой обработке. Проблема состоит в том, что при регистрации события <code>ondblclick</code> все равно вызывается событие <code>onclick</code>. Поэтому, если уж очень это событие (неочевидное, стоит заметить, для пользователя сети) необходимо - лучше всего иметь в скриптах что-то вроде такого кода (с необходимым вам количеством миллисекунд и сохраняя, если необходимо, элемент, на котором был совершен клик):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">dblClicked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">dblClickedNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">DBL_CLICK_MAXTIME</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">dblClick</span><span class="p">(</span><span class="nx">clickedNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dblClicked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">dblClickedNode</span> <span class="o">=</span> <span class="nx">clickedNode</span> <span class="o">||</span> <span class="nx">dblClickedNode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">releaseDblClick</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="s1">&#39;dblClicked=false;&#39;</span><span class="p">,</span> <span class="nx">DBL_CLICK_MAXTIME</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Его использование накладывает относительно сложные условия. Теперь в обработчике <code>ondblclick</code> нужно вызывать сначала первую функцию, затем - закончив собственно обработку - вторую, а в обработчике <code>onclick</code> проверять, не совершен ли двойной клик:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;someId&quot;</span> <span class="na">onclick=</span><span class="s">&quot;if (!dblClicked) alert(&#39;click&#39;);&quot;</span>
     <span class="na">ondblick=</span><span class="s">&quot;dblClick(this); alert(&#39;dblclick&#39;); releaseDblClick();&quot;</span><span class="err">;</span><span class="nt">&gt;&lt;/div&gt;</span>
</pre></div>
</td></tr></table></div></div>
<p>Также, к пункту <em><a href="#sol-1">1</a></em> можно добавить небольшую функцию <strong>получения инстанса</strong> (на ваше усмотрение вы можете изменить ее так, чтобы она предавала аргументы в конструктор):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getInstanceOf</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;new &#39;</span> <span class="o">+</span> <span class="nx">className</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>К пункту <em><a href="#sol-6">6</a></em> подойдет функция <strong>паузы</strong> (именно паузы, а не выполнения в отдельном поптоке, как делает setTimeout):</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">pause</span><span class="p">(</span><span class="nx">millis</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">curTime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span> <span class="nx">curTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span> <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">curTime</span> <span class="o">-</span> <span class="nx">time</span> <span class="o">&lt;</span> <span class="nx">millis</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>Upd.</strong> Ещё пара функций, относящихся к пункту  <em><a href="#sol-6">6</a></em>:</p>

<p>Определение <strong>Вхождения числа в область</strong> чисел, ограниченную числом <code>start</code> спереди включительно и числом <code>stop</code> в конце исключительно:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">Number</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inBounds</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="nx">stop</span><span class="p">){</span><span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="o">&gt;=</span><span class="nx">start</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">&lt;</span><span class="nx">stop</span><span class="p">))</span><span class="o">?</span><span class="kc">true</span><span class="o">:</span><span class="kc">false</span><span class="p">;};</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>Срезание</strong> начальных и конечных <strong>пробельных символов строки</strong>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">trim</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/^\s+/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span><span class="k">return</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/\s+$/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">);}</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>Преобразование</strong> объекта и строки <strong>в тип <code>boolean</code></strong>. Для <code>boolean</code>-объектов метод также описан, ввиду того, что данные о типе переданного объекта (строка или <code>boolean</code>) могут быть неизвестны:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">boolFromObj</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">return</span><span class="p">(((</span><span class="nx">obj</span><span class="o">==</span><span class="s2">&quot;true&quot;</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">true</span><span class="p">))</span><span class="o">?</span><span class="kc">true</span><span class="o">:</span><span class="kc">false</span><span class="p">);}</span>

<span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">asBoolVal</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="o">==</span><span class="s2">&quot;true&quot;</span><span class="p">)</span><span class="o">?</span><span class="kc">true</span><span class="o">:</span><span class="kc">false</span><span class="p">);}</span>

<span class="nb">Boolean</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">asBoolVal</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="p">((</span><span class="k">this</span><span class="o">==</span><span class="kc">true</span><span class="p">)</span><span class="o">?</span><span class="kc">true</span><span class="o">:</span><span class="kc">false</span><span class="p">);}</span>
</pre></div>
</td></tr></table></div></div>
<p><strong>Дополнение нулями</strong> числа до тех пор, пока количество цифр в нём не достигнет указанного:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">Number</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getFStr</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">fillNum</span><span class="p">){</span><span class="kd">var</span> <span class="nx">fillNum</span><span class="o">=</span><span class="nx">fillNum</span><span class="o">?</span><span class="nx">fillNum</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span><span class="kd">var</span>
<span class="nx">temp</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">temp</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="nx">fillNum</span><span class="p">)</span><span class="nx">temp</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="nx">temp</span><span class="p">;</span><span class="k">return</span> <span class="nx">temp</span><span class="p">;}</span>
</pre></div>
</td></tr></table></div></div>
<p>Кроме этого, ко <a href="#%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BD%D0%B0%D1%8F-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-js">второй части</a> можно отнести функции, связанные с <strong>сортировкой</strong>,&hellip;</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">intComparator</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getObjSortedProps</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">sortFunc</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">propsArr</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">propName</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">propsArr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">propName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">propsArr</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortFunc</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>&hellip;где функция <code>getObjSortedProps</code> позволяет получить массив из отсортированных (с применением указанного компаратора <code>sortFunc</code>) имён свойств переданного объекта, а функция <code>intComparator</code> может быть передана функции массивов <code>sort</code> или той же самой <code>getObjSortedProps</code>, если нужный массив или имена свойств объекта содержит/содержат числовые значения&hellip;</p>

<p>&hellip;и две функции для <strong>работы с массивами</strong>:</p>
<div class="code"><div><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">itemIdx</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">itemIdx</span><span class="p">]</span> <span class="o">==</span> <span class="nx">elem</span><span class="p">)</span> <span class="k">return</span> <span class="nx">itemIdx</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeFromArray</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// removes only one item!</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">itemIndex</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">itemIndex</span><span class="p">]</span> <span class="o">==</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">itemIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p><code>indexOf</code> возвращает индекс указанного элемента в переданном массиве, а функция <code>removeFromArray</code> удаляет из указанного массива переданный элемент.</p>
<h3 id="заключение"><a href="#заключение" title="Заключение">Заключение</a></h3>
<p>Ну вот &ndash; кажется, пока всё. Статья &ndash; в состоянии готовности к исправлениям (если понадобятся :) ), можно переходить к следующим :). В <a href="#javascript-oop">следующей статье</a> я намереваюсь рассказать поподробнее про ООП в JavaScript и привести в пример пару простых, но полезных классов. Надеюсь, эта статья вам помогла и хоть немного сократила имеющие потенциальную возможность быть потраченными на решение всяких причуд браузеров рабочие человекочасы.</p>

        </div>
    </article>

        </div>
        
        
            <ul id="nwao-social">
    <li><a href="https://twitter.com/#!/shaman_sir" title="профиль в Twitter"><img src="/blog/ru/assets/img/social/twitter.png" width="16" height="16" alt="профиль в Twitter"></a></li>
    <li><a href="https://github.com/shamansir" title="профиль на Github"><img src="/blog/ru/assets/img/social/github.png" width="16" height="16" alt="профиль на Github"></a></li>                
    
    <li><a href="https://www.facebook.com/shaman.sir" title="профиль в Facebook"><img src="/blog/ru/assets/img/social/facebook.png" width="16" height="16" alt="профиль в Facebook"></a></li>
    
    
    <li><a href="http://stackoverflow.com/users/167262" title="профиль на Stackoverflow"><img src="/blog/ru/assets/img/social/stack-overflow.png" width="16" height="16" alt="профиль на Stack Overflow"></a></li>
    
</ul>
        

        <div id="nwao-footer">
            <p>Copyright &copy; 2012 Ulric Wilfred &ndash; запитано <a href="http://mynt.mirroredwhite.com/">mynt</a></p>
        </div>

        <div id="nwao-jump-to-top"><a href="#top" title="Вира!">&#x2912;</a></div>

        <!--
        <script type="text/javascript" src="/blog/ru/assets/js/scrolls.js"></script>
        <script type="text/javascript" src="/blog/ru/assets/js/page.scrolls.js"></script> -->


        </script>
    </div>

    <div id="nwao-onion"></div>
</body>
</html>